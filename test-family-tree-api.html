<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Tree API Test - ÿßÿÆÿ™ÿ®ÿßÿ± ÿ¥ÿ¨ÿ±ÿ© ÿßŸÑÿπÿßÿ¶ŸÑÿ©</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Cairo', 'Tajawal', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .test-panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .test-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        button {
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-family: inherit;
            transition: transform 0.2s;
        }

        button:hover {
            transform: scale(1.05);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .status {
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .results {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            min-height: 200px;
            max-height: 600px;
            overflow-y: auto;
        }

        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 14px;
        }

        .member-select {
            padding: 8px;
            border: 2px solid #667eea;
            border-radius: 5px;
            font-size: 16px;
            margin-left: 10px;
        }

        .timer {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(255,255,255,0.9);
            padding: 10px;
            border-radius: 8px;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .tree-visual {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            text-align: center;
        }

        .family-node {
            display: inline-block;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 10px 15px;
            margin: 5px;
            border-radius: 5px;
            position: relative;
        }
    </style>
</head>
<body>
    <div class="timer" id="timer">Response Time: --ms</div>

    <div class="container">
        <h1>üå≥ ÿßÿÆÿ™ÿ®ÿßÿ± Ÿàÿßÿ¨Ÿáÿ© ÿ®ÿ±ŸÖÿ¨ÿ© ÿ¥ÿ¨ÿ±ÿ© ÿßŸÑÿπÿßÿ¶ŸÑÿ© - Family Tree API Test</h1>

        <div class="test-panel">
            <h2>API Endpoint Tests</h2>
            <div id="status" class="status info">Ready to test...</div>

            <div class="test-controls">
                <select id="memberSelect" class="member-select">
                    <option value="">Select a member...</option>
                </select>

                <button onclick="testGetFamilyTree()" id="btnGetTree">
                    Get Family Tree üå≥
                </button>

                <button onclick="testGetRelationships()" id="btnGetRel">
                    Get Relationships üë•
                </button>

                <button onclick="testAddRelationship()" id="btnAddRel">
                    Add Test Relationship ‚ûï
                </button>

                <button onclick="testStatistics()" id="btnStats">
                    Get Statistics üìä
                </button>

                <button onclick="loadMembers()">
                    Reload Members üîÑ
                </button>

                <button onclick="runPerformanceTest()">
                    Performance Test ‚ö°
                </button>
            </div>

            <div class="results">
                <pre id="results">Results will appear here...</pre>
            </div>

            <div id="treeVisual" class="tree-visual" style="display:none;">
                <h3>Visual Tree</h3>
                <div id="treeContent"></div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3001/api';
        const token = localStorage.getItem('token') || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOiIxIiwicm9sZSI6ImFkbWluIiwiaWF0IjoxNzI3NTAwMDAwfQ.example';

        let selectedMemberId = null;
        let members = [];

        // Load members on page load
        window.onload = () => {
            loadMembers();
        };

        async function loadMembers() {
            updateStatus('Loading members...', 'info');
            try {
                const response = await fetch(`${API_BASE}/members?limit=10`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();
                members = data.members || data.data || [];

                const select = document.getElementById('memberSelect');
                select.innerHTML = '<option value="">Select a member...</option>';

                members.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member.id;
                    option.textContent = `${member.name} (${member.member_id})`;
                    select.appendChild(option);
                });

                updateStatus(`Loaded ${members.length} members`, 'success');
                showResults(members);
            } catch (error) {
                updateStatus(`Error loading members: ${error.message}`, 'error');
            }
        }

        document.getElementById('memberSelect').addEventListener('change', (e) => {
            selectedMemberId = e.target.value;
            if (selectedMemberId) {
                updateStatus(`Selected member ID: ${selectedMemberId}`, 'info');
            }
        });

        async function testGetFamilyTree() {
            if (!selectedMemberId) {
                updateStatus('Please select a member first', 'error');
                return;
            }

            const startTime = Date.now();
            updateStatus('Fetching family tree...', 'info');

            try {
                const response = await fetch(`${API_BASE}/family-tree/tree/${selectedMemberId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();
                const responseTime = Date.now() - startTime;

                document.getElementById('timer').textContent = `Response Time: ${responseTime}ms`;

                if (response.ok) {
                    updateStatus(`‚úÖ Family tree fetched successfully in ${responseTime}ms`, 'success');
                    showResults(data);
                    visualizeTree(data.data);
                } else {
                    updateStatus(`‚ùå Error: ${data.error}`, 'error');
                    showResults(data);
                }
            } catch (error) {
                updateStatus(`‚ùå Network error: ${error.message}`, 'error');
                showResults({ error: error.message });
            }
        }

        async function testGetRelationships() {
            if (!selectedMemberId) {
                updateStatus('Please select a member first', 'error');
                return;
            }

            const startTime = Date.now();
            updateStatus('Fetching relationships...', 'info');

            try {
                const response = await fetch(`${API_BASE}/family-tree/relationships/${selectedMemberId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();
                const responseTime = Date.now() - startTime;

                document.getElementById('timer').textContent = `Response Time: ${responseTime}ms`;

                if (response.ok) {
                    updateStatus(`‚úÖ Found ${data.count} relationships in ${responseTime}ms`, 'success');
                    showResults(data);
                } else {
                    updateStatus(`‚ùå Error: ${data.error}`, 'error');
                    showResults(data);
                }
            } catch (error) {
                updateStatus(`‚ùå Network error: ${error.message}`, 'error');
                showResults({ error: error.message });
            }
        }

        async function testAddRelationship() {
            if (!selectedMemberId || members.length < 2) {
                updateStatus('Need at least 2 members to create relationship', 'error');
                return;
            }

            // Find another member to create relationship with
            const otherMember = members.find(m => m.id !== selectedMemberId);
            if (!otherMember) {
                updateStatus('Could not find another member', 'error');
                return;
            }

            const relationshipData = {
                memberId: selectedMemberId,
                relatedMemberId: otherMember.id,
                relationshipType: 'sibling'
            };

            updateStatus('Creating test relationship...', 'info');

            try {
                const response = await fetch(`${API_BASE}/family-tree/relationships`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(relationshipData)
                });

                const data = await response.json();

                if (response.ok) {
                    updateStatus(`‚úÖ Relationship created successfully`, 'success');
                    showResults(data);
                } else {
                    updateStatus(`‚ùå Error: ${data.error}`, 'error');
                    showResults(data);
                }
            } catch (error) {
                updateStatus(`‚ùå Network error: ${error.message}`, 'error');
                showResults({ error: error.message });
            }
        }

        async function testStatistics() {
            const startTime = Date.now();
            updateStatus('Fetching family statistics...', 'info');

            try {
                const response = await fetch(`${API_BASE}/family-tree/statistics`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();
                const responseTime = Date.now() - startTime;

                document.getElementById('timer').textContent = `Response Time: ${responseTime}ms`;

                if (response.ok) {
                    updateStatus(`‚úÖ Statistics fetched in ${responseTime}ms`, 'success');
                    showResults(data);
                } else {
                    updateStatus(`‚ùå Error: ${data.error}`, 'error');
                    showResults(data);
                }
            } catch (error) {
                updateStatus(`‚ùå Network error: ${error.message}`, 'error');
                showResults({ error: error.message });
            }
        }

        async function runPerformanceTest() {
            updateStatus('Starting performance test...', 'info');
            const results = [];

            // Test with multiple members
            const testMembers = members.slice(0, 5); // Test first 5 members

            for (const member of testMembers) {
                const startTime = Date.now();

                try {
                    const response = await fetch(`${API_BASE}/family-tree/tree/${member.id}`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    const data = await response.json();
                    const responseTime = Date.now() - startTime;

                    results.push({
                        memberId: member.id,
                        memberName: member.name,
                        responseTime: responseTime,
                        success: response.ok,
                        relationshipCount: data.relationshipCount || 0
                    });
                } catch (error) {
                    results.push({
                        memberId: member.id,
                        memberName: member.name,
                        error: error.message
                    });
                }
            }

            const avgTime = results.reduce((sum, r) => sum + (r.responseTime || 0), 0) / results.length;

            updateStatus(`‚úÖ Performance test complete. Avg: ${avgTime.toFixed(0)}ms`, 'success');
            showResults({
                summary: {
                    totalTests: results.length,
                    averageResponseTime: `${avgTime.toFixed(2)}ms`,
                    fastest: Math.min(...results.map(r => r.responseTime || Infinity)) + 'ms',
                    slowest: Math.max(...results.map(r => r.responseTime || 0)) + 'ms'
                },
                details: results
            });
        }

        function updateStatus(message, type) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }

        function showResults(data) {
            document.getElementById('results').textContent = JSON.stringify(data, null, 2);
        }

        function visualizeTree(treeData) {
            if (!treeData) return;

            const visual = document.getElementById('treeVisual');
            const content = document.getElementById('treeContent');

            visual.style.display = 'block';
            content.innerHTML = '';

            // Root member
            const rootNode = document.createElement('div');
            rootNode.className = 'family-node';
            rootNode.textContent = `${treeData.name} (Root)`;
            content.appendChild(rootNode);

            // Parents
            if (treeData.parents && treeData.parents.length > 0) {
                const parentsDiv = document.createElement('div');
                parentsDiv.innerHTML = '<h4>ÿßŸÑŸàÿßŸÑÿØŸäŸÜ:</h4>';
                treeData.parents.forEach(parent => {
                    const node = document.createElement('span');
                    node.className = 'family-node';
                    node.textContent = parent.name;
                    parentsDiv.appendChild(node);
                });
                content.appendChild(parentsDiv);
            }

            // Spouse
            if (treeData.spouse) {
                const spouseDiv = document.createElement('div');
                spouseDiv.innerHTML = '<h4>ÿßŸÑÿ≤Ÿàÿ¨/ÿßŸÑÿ≤Ÿàÿ¨ÿ©:</h4>';
                const node = document.createElement('span');
                node.className = 'family-node';
                node.textContent = treeData.spouse.name;
                spouseDiv.appendChild(node);
                content.appendChild(spouseDiv);
            }

            // Children
            if (treeData.children && treeData.children.length > 0) {
                const childrenDiv = document.createElement('div');
                childrenDiv.innerHTML = '<h4>ÿßŸÑÿ£ÿ®ŸÜÿßÿ°:</h4>';
                treeData.children.forEach(child => {
                    const node = document.createElement('span');
                    node.className = 'family-node';
                    node.textContent = child.name;
                    childrenDiv.appendChild(node);
                });
                content.appendChild(childrenDiv);
            }

            // Siblings
            if (treeData.siblings && treeData.siblings.length > 0) {
                const siblingsDiv = document.createElement('div');
                siblingsDiv.innerHTML = '<h4>ÿßŸÑÿ•ÿÆŸàÿ©:</h4>';
                treeData.siblings.forEach(sibling => {
                    const node = document.createElement('span');
                    node.className = 'family-node';
                    node.textContent = sibling.name;
                    siblingsDiv.appendChild(node);
                });
                content.appendChild(siblingsDiv);
            }
        }
    </script>
</body>
</html>