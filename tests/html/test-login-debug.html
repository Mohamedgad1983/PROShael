<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Login - AL-SHUAIL</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            margin: 20px;
            background: #f5f5f7;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 8px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 6px;
        }
        .success {
            background: #d4edda;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
        }
        .warning {
            background: #fff3cd;
            color: #856404;
        }
        .loading {
            background: #d1ecf1;
            color: #0c5460;
        }
        button {
            background: #007AFF;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            margin: 10px 0;
        }
        button:hover {
            background: #0051D5;
        }
        pre {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” ØªØ´Ø®ÙŠØµ Ù…Ø´ÙƒÙ„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h1>

        <div class="test-section">
            <h3>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±:</h3>
            <p>Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„: 0555555555</p>
            <p>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±: 123456</p>
        </div>

        <button onclick="testBackendHealth()">1. ÙØ­Øµ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø§Ø¯Ù…</button>
        <button onclick="testDirectLogin()">2. Ø§Ø®ØªØ¨Ø§Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</button>
        <button onclick="testFrontendAPI()">3. ÙØ­Øµ API Ù…Ù† Frontend</button>
        <button onclick="checkLocalStorage()">4. ÙØ­Øµ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©</button>
        <button onclick="clearAndRetry()">5. Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button>

        <div id="results"></div>
    </div>

    <script>
        const API_URL = 'https://proshael.onrender.com';
        const FRONTEND_URL = 'https://alshuail-admin.pages.dev';

        function addResult(message, type = 'loading') {
            const resultsDiv = document.getElementById('results');
            const statusDiv = document.createElement('div');
            statusDiv.className = `status ${type}`;
            statusDiv.innerHTML = `<strong>${new Date().toLocaleTimeString('ar-SA')}:</strong> ${message}`;
            resultsDiv.insertBefore(statusDiv, resultsDiv.firstChild);
        }

        async function testBackendHealth() {
            addResult('Ø¬Ø§Ø±ÙŠ ÙØ­Øµ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø§Ø¯Ù…...', 'loading');

            try {
                const response = await fetch(`${API_URL}/api/health`, {
                    method: 'GET',
                    mode: 'cors'
                });

                if (response.ok) {
                    const data = await response.json();
                    addResult(`âœ… Ø§Ù„Ø®Ø§Ø¯Ù… ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­! Status: ${data.status || 'OK'}`, 'success');
                } else {
                    addResult(`âš ï¸ Ø§Ù„Ø®Ø§Ø¯Ù… ÙŠØ³ØªØ¬ÙŠØ¨ ÙˆÙ„ÙƒÙ† Ø¨Ø­Ø§Ù„Ø©: ${response.status} ${response.statusText}`, 'warning');
                }
            } catch (error) {
                addResult(`âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ø®Ø§Ø¯Ù…: ${error.message}`, 'error');
                addResult('ğŸ”„ Ø§Ù„Ø®Ø§Ø¯Ù… Ù‚Ø¯ ÙŠÙƒÙˆÙ† ÙÙŠ ÙˆØ¶Ø¹ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„. Ø§Ù†ØªØ¸Ø± 2-3 Ø¯Ù‚Ø§Ø¦Ù‚.', 'warning');
            }
        }

        async function testDirectLogin() {
            addResult('Ø¬Ø§Ø±ÙŠ Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...', 'loading');

            try {
                const response = await fetch(`${API_URL}/api/auth/mobile-login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    mode: 'cors',
                    body: JSON.stringify({
                        phone: '0555555555',
                        password: '123456'
                    })
                });

                const data = await response.json();

                if (data.success && data.token) {
                    addResult(`âœ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù†Ø¬Ø­! Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${data.user?.name}`, 'success');
                    addResult(`Token: ${data.token.substring(0, 20)}...`, 'success');

                    // Save to localStorage
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('user', JSON.stringify(data.user));
                    addResult('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­', 'success');
                } else {
                    addResult(`âŒ ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: ${data.message || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                addResult(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: ${error.message}`, 'error');

                // Try alternative endpoints
                addResult('Ø¬Ø§Ø±ÙŠ ØªØ¬Ø±Ø¨Ø© Ù†Ù‚Ø§Ø· ÙˆØµÙˆÙ„ Ø¨Ø¯ÙŠÙ„Ø©...', 'loading');

                try {
                    const altResponse = await fetch(`${API_URL}/api/auth/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ phone: '0555555555', password: '123456' })
                    });

                    if (altResponse.ok) {
                        addResult('âœ… ÙˆØ¬Ø¯Øª Ù†Ù‚Ø·Ø© ÙˆØµÙˆÙ„ Ø¨Ø¯ÙŠÙ„Ø© ØªØ¹Ù…Ù„!', 'success');
                    }
                } catch (altError) {
                    addResult('âŒ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø¨Ø¯ÙŠÙ„Ø© Ù„Ø§ ØªØ¹Ù…Ù„ Ø£ÙŠØ¶Ø§Ù‹', 'error');
                }
            }
        }

        async function testFrontendAPI() {
            addResult('Ø¬Ø§Ø±ÙŠ ÙØ­Øµ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Frontend...', 'loading');

            try {
                // Check if frontend is accessible
                const frontendResponse = await fetch(`${FRONTEND_URL}/mobile/login`, {
                    method: 'GET',
                    mode: 'no-cors'
                });

                addResult('âœ… Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø£Ù…Ø§Ù…ÙŠØ© Ù…ØªØ§Ø­Ø©', 'success');

                // Check localStorage for API URL
                const apiUrl = localStorage.getItem('API_URL') || 'Not set';
                addResult(`API URL ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­: ${apiUrl}`, 'warning');

            } catch (error) {
                addResult(`âš ï¸ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙˆØ§Ø¬Ù‡Ø©: ${error.message}`, 'warning');
            }
        }

        function checkLocalStorage() {
            addResult('Ø¬Ø§Ø±ÙŠ ÙØ­Øµ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©...', 'loading');

            const token = localStorage.getItem('token');
            const user = localStorage.getItem('user');
            const memberData = localStorage.getItem('memberData');

            if (token) {
                addResult(`âœ… ÙŠÙˆØ¬Ø¯ Token Ù…Ø­ÙÙˆØ¸: ${token.substring(0, 20)}...`, 'success');

                // Decode token to check expiry
                try {
                    const payload = JSON.parse(atob(token.split('.')[1]));
                    const expiry = new Date(payload.exp * 1000);
                    const now = new Date();

                    if (expiry > now) {
                        addResult(`âœ… Token ØµØ§Ù„Ø­ Ø­ØªÙ‰: ${expiry.toLocaleString('ar-SA')}`, 'success');
                    } else {
                        addResult('âŒ Token Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©', 'error');
                    }
                } catch (e) {
                    addResult('âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† ÙØ­Øµ ØµÙ„Ø§Ø­ÙŠØ© Token', 'warning');
                }
            } else {
                addResult('âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Token Ù…Ø­ÙÙˆØ¸', 'error');
            }

            if (user) {
                const userData = JSON.parse(user);
                addResult(`âœ… Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${userData.name || userData.full_name}`, 'success');
            } else {
                addResult('âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø³ØªØ®Ø¯Ù…', 'error');
            }

            if (memberData) {
                addResult('âœ… ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ù…Ø­ÙÙˆØ¸Ø©', 'success');
            }
        }

        function clearAndRetry() {
            addResult('Ø¬Ø§Ø±ÙŠ Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©...', 'loading');

            localStorage.removeItem('token');
            localStorage.removeItem('user');
            localStorage.removeItem('memberData');

            addResult('âœ… ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'success');
            addResult('ğŸ”„ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù…Ù† Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©', 'warning');

            setTimeout(() => {
                if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø°Ù‡Ø§Ø¨ Ù„ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¢Ù†ØŸ')) {
                    window.location.href = `${FRONTEND_URL}/mobile/login`;
                }
            }, 2000);
        }

        // Auto-run health check on load
        window.onload = () => {
            addResult('ğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´Ø®ÙŠØµ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ...', 'loading');
            testBackendHealth();
        };
    </script>
</body>
</html>