<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Service Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 10px 0;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .info { color: #17a2b8; }
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            white-space: pre-wrap;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ Al-Shuail API Service Test</h1>

    <div class="test-section">
        <h2>API Health Check</h2>
        <button onclick="testHealthCheck()">ğŸ¥ Test Health Check</button>
        <div id="health-result"></div>
    </div>

    <div class="test-section">
        <h2>Admin Login Test</h2>
        <input type="email" id="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" value="admin@alshuail.com">
        <input type="password" id="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" value="admin123">
        <br><br>
        <button onclick="testLogin()">ğŸ” Test Login</button>
        <button onclick="testLoginWithPhone()">ğŸ“± Test Phone Login</button>
        <div id="login-result"></div>
    </div>

    <div class="test-section">
        <h2>Dashboard Data Test</h2>
        <button onclick="testDashboard()">ğŸ“Š Test Dashboard Stats</button>
        <button onclick="testDashboardWithAuth()">ğŸ“Š Test with Auth</button>
        <div id="dashboard-result"></div>
    </div>

    <div class="test-section">
        <h2>Members Data Test</h2>
        <button onclick="testMembers()">ğŸ‘¥ Test Members</button>
        <div id="members-result"></div>
    </div>

    <div class="test-section">
        <h2>API Service Test</h2>
        <button onclick="initializeApiService()">ğŸš€ Initialize API Service</button>
        <button onclick="testCacheStatus()">ğŸ“‹ Check Cache Status</button>
        <button onclick="clearApiCache()">ğŸ—‘ï¸ Clear Cache</button>
        <div id="api-service-result"></div>
    </div>

    <script>
        // Import the API service (simplified for testing)
        class APIService {
            constructor() {
                this.baseURL = 'https://proshael.onrender.com';
                this.cache = new Map();
                this.cacheDuration = 5 * 60 * 1000; // 5 minutes
                this.maxRetries = 3;
                this.retryDelay = 1000; // 1 second
                console.log('ğŸ”§ API Service initialized with baseURL:', this.baseURL);
            }

            async request(endpoint, options = {}) {
                return this.requestWithRetry(endpoint, options, this.maxRetries);
            }

            async requestWithRetry(endpoint, options = {}, retries = 0) {
                const url = `${this.baseURL}${endpoint}`;
                const cacheKey = `${options.method || 'GET'}:${url}:${JSON.stringify(options.body || {})}`;

                // Check cache first for GET requests
                if (!options.method || options.method === 'GET') {
                    const cached = this.getFromCache(cacheKey);
                    if (cached) {
                        console.log('ğŸ“‹ Using cached data for:', endpoint);
                        return cached;
                    }
                }

                const config = {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers,
                    },
                    timeout: 30000, // 30 seconds
                    ...options,
                };

                // Always add authorization header if token exists
                const token = localStorage.getItem('token');
                if (token) {
                    config.headers['Authorization'] = `Bearer ${token}`;
                }

                try {
                    console.log('ğŸŒ API Request:', {
                        url,
                        method: config.method || 'GET',
                        hasToken: !!config.headers['Authorization'],
                        attempt: this.maxRetries - retries + 1,
                        endpoint
                    });

                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), config.timeout);

                    const response = await fetch(url, {
                        ...config,
                        signal: controller.signal
                    });

                    clearTimeout(timeoutId);

                    let data;
                    try {
                        data = await response.json();
                    } catch (parseError) {
                        console.warn('âš ï¸ Failed to parse JSON response:', parseError);
                        data = { error: 'Invalid response format' };
                    }

                    if (!response.ok) {
                        console.error('âŒ API Error Response:', {
                            status: response.status,
                            statusText: response.statusText,
                            error: data.error,
                            url,
                            endpoint
                        });

                        // Handle authentication errors
                        if (response.status === 401 || response.status === 403) {
                            console.warn('ğŸ”‘ Authentication error detected');
                        }

                        // Handle server errors with retry
                        if (response.status >= 500 && retries > 0) {
                            console.warn(`â³ Server error ${response.status}, retrying in ${this.retryDelay}ms...`);
                            await this.delay(this.retryDelay * (this.maxRetries - retries + 1));
                            return this.requestWithRetry(endpoint, options, retries - 1);
                        }

                        throw new Error(data.error || `HTTP ${response.status}: ${response.statusText}`);
                    }

                    console.log('âœ… API Success:', {
                        endpoint,
                        status: response.status,
                        dataKeys: Object.keys(data)
                    });

                    // Cache successful GET requests
                    if (!options.method || options.method === 'GET') {
                        this.setCache(cacheKey, data);
                    }

                    return data;
                } catch (error) {
                    console.error('ğŸ’¥ API Request Failed:', {
                        endpoint,
                        error: error.message,
                        type: error.name,
                        retriesLeft: retries
                    });

                    // Network or timeout errors - retry if we have attempts left
                    if (retries > 0 && (error.name === 'AbortError' || error.name === 'TypeError' || error.message.includes('fetch'))) {
                        console.warn(`ğŸ”„ Retrying request to ${endpoint} (${retries} attempts left)...`);
                        await this.delay(this.retryDelay * (this.maxRetries - retries + 1));
                        return this.requestWithRetry(endpoint, options, retries - 1);
                    }

                    // Return cached data as fallback for GET requests
                    if (!options.method || options.method === 'GET') {
                        const cached = this.getFromCache(cacheKey, true); // Get even expired cache
                        if (cached) {
                            console.warn('ğŸ“‹ Using stale cached data as fallback for:', endpoint);
                            return cached;
                        }

                        // Return mock data as last resort
                        const mockData = this.getMockData(endpoint);
                        if (mockData) {
                            console.warn('ğŸ­ Using mock data as fallback for:', endpoint);
                            return mockData;
                        }
                    }

                    throw error;
                }
            }

            async delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }

            setCache(key, data) {
                this.cache.set(key, {
                    data,
                    timestamp: Date.now()
                });
            }

            getFromCache(key, allowStale = false) {
                const cached = this.cache.get(key);
                if (!cached) return null;

                const isExpired = Date.now() - cached.timestamp > this.cacheDuration;
                if (isExpired && !allowStale) {
                    this.cache.delete(key);
                    return null;
                }

                return cached.data;
            }

            getMockData(endpoint) {
                const mockData = {
                    '/api/dashboard/stats': {
                        success: true,
                        data: {
                            members: { total: 299, active: 288, inactive: 11, newThisMonth: 5 },
                            payments: { pending: 12, pendingAmount: 36000, monthlyRevenue: 150000, totalRevenue: 2500000, totalPaid: 287 },
                            subscriptions: { active: 280, expired: 19, total: 299, revenue: 840000 },
                            activities: [
                                { id: 1, type: 'payment', description: 'Ø¯ÙØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù…Ù† Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯', date: new Date().toISOString(), amount: 3000 },
                                { id: 2, type: 'member', description: 'Ø¹Ø¶Ùˆ Ø¬Ø¯ÙŠØ¯ Ø§Ù†Ø¶Ù… Ù„Ù„Ù†Ø¸Ø§Ù…', date: new Date().toISOString(), amount: null },
                                { id: 3, type: 'occasion', description: 'Ù…Ù†Ø§Ø³Ø¨Ø© Ø¬Ø¯ÙŠØ¯Ø© ØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡Ø§', date: new Date().toISOString(), amount: null }
                            ]
                        }
                    },
                    '/api/members': {
                        success: true,
                        data: Array.from({ length: 10 }, (_, i) => ({
                            id: i + 1,
                            full_name: `Ø¹Ø¶Ùˆ ØªØ¬Ø±ÙŠØ¨ÙŠ ${i + 1}`,
                            phone: `050123456${i}`,
                            membership_number: `SH${String(i + 1).padStart(3, '0')}`,
                            balance: Math.floor(Math.random() * 5000) + 1000,
                            membership_status: 'active',
                            tribal_section: 'Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø£ÙˆÙ„',
                            created_at: new Date().toISOString()
                        }))
                    }
                };

                return mockData[endpoint] || null;
            }

            async login(email, password) {
                return this.request('/api/auth/login', {
                    method: 'POST',
                    body: JSON.stringify({ email, password }),
                });
            }

            async getDashboardStats() {
                return this.request('/api/dashboard/stats');
            }

            async getMembers() {
                return this.request('/api/members');
            }

            async healthCheck() {
                return this.request('/api/health');
            }

            clearCache() {
                this.cache.clear();
                console.log('ğŸ§¹ API cache cleared');
            }

            getCacheStatus() {
                return {
                    size: this.cache.size,
                    keys: Array.from(this.cache.keys()),
                    oldest: Math.min(...Array.from(this.cache.values()).map(v => v.timestamp)),
                    newest: Math.max(...Array.from(this.cache.values()).map(v => v.timestamp))
                };
            }
        }

        let apiService;

        function setResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        function setResultWithData(elementId, message, data, type = 'success') {
            const element = document.getElementById(elementId);
            element.innerHTML = `
                <div class="status ${type}">${message}</div>
                <pre>${JSON.stringify(data, null, 2)}</pre>
            `;
        }

        async function testHealthCheck() {
            setResult('health-result', 'ğŸ¥ Testing health check...', 'info');

            try {
                if (!apiService) {
                    apiService = new APIService();
                }

                const result = await apiService.healthCheck();
                setResultWithData('health-result', 'âœ… Health check successful!', result, 'success');
            } catch (error) {
                setResult('health-result', `âŒ Health check failed: ${error.message}`, 'error');
            }
        }

        async function testLogin() {
            setResult('login-result', 'ğŸ” Testing login...', 'info');

            try {
                if (!apiService) {
                    apiService = new APIService();
                }

                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;

                const result = await apiService.login(email, password);

                if (result.success && result.token) {
                    localStorage.setItem('token', result.token);
                    setResultWithData('login-result', 'âœ… Login successful! Token saved.', result, 'success');
                } else {
                    setResult('login-result', `âŒ Login failed: ${result.error || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                setResult('login-result', `âŒ Login error: ${error.message}`, 'error');
            }
        }

        async function testLoginWithPhone() {
            setResult('login-result', 'ğŸ“± Testing phone login...', 'info');

            try {
                if (!apiService) {
                    apiService = new APIService();
                }

                // Try with admin phone
                const result = await apiService.request('/api/auth/login', {
                    method: 'POST',
                    body: JSON.stringify({
                        phone: '0501234567',
                        password: 'admin123',
                        role: 'super_admin'
                    }),
                });

                if (result.success && result.token) {
                    localStorage.setItem('token', result.token);
                    setResultWithData('login-result', 'âœ… Phone login successful! Token saved.', result, 'success');
                } else {
                    setResult('login-result', `âŒ Phone login failed: ${result.error || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                setResult('login-result', `âŒ Phone login error: ${error.message}`, 'error');
            }
        }

        async function testDashboard() {
            setResult('dashboard-result', 'ğŸ“Š Testing dashboard without auth...', 'info');

            try {
                if (!apiService) {
                    apiService = new APIService();
                }

                const result = await apiService.getDashboardStats();
                setResultWithData('dashboard-result', 'âœ… Dashboard data loaded!', result, 'success');
            } catch (error) {
                setResult('dashboard-result', `âŒ Dashboard test failed: ${error.message}`, 'error');
            }
        }

        async function testDashboardWithAuth() {
            setResult('dashboard-result', 'ğŸ“Š Testing dashboard with auth...', 'info');

            const token = localStorage.getItem('token');
            if (!token) {
                setResult('dashboard-result', 'âŒ No token found. Please login first.', 'error');
                return;
            }

            try {
                if (!apiService) {
                    apiService = new APIService();
                }

                const result = await apiService.getDashboardStats();
                setResultWithData('dashboard-result', 'âœ… Dashboard data loaded with auth!', result, 'success');
            } catch (error) {
                setResult('dashboard-result', `âŒ Dashboard with auth failed: ${error.message}`, 'error');
            }
        }

        async function testMembers() {
            setResult('members-result', 'ğŸ‘¥ Testing members...', 'info');

            try {
                if (!apiService) {
                    apiService = new APIService();
                }

                const result = await apiService.getMembers();
                setResultWithData('members-result', `âœ… Members loaded! Count: ${result.data?.length || 0}`, result, 'success');
            } catch (error) {
                setResult('members-result', `âŒ Members test failed: ${error.message}`, 'error');
            }
        }

        function initializeApiService() {
            apiService = new APIService();
            setResult('api-service-result', 'âœ… API Service initialized successfully!', 'success');
        }

        function testCacheStatus() {
            if (!apiService) {
                setResult('api-service-result', 'âŒ API Service not initialized', 'error');
                return;
            }

            const status = apiService.getCacheStatus();
            setResultWithData('api-service-result', 'ğŸ“‹ Cache Status:', status, 'info');
        }

        function clearApiCache() {
            if (!apiService) {
                setResult('api-service-result', 'âŒ API Service not initialized', 'error');
                return;
            }

            apiService.clearCache();
            setResult('api-service-result', 'âœ… Cache cleared successfully!', 'success');
        }

        // Auto-initialize on page load
        window.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸš€ API Test Page loaded');
            initializeApiService();
        });
    </script>
</body>
</html>