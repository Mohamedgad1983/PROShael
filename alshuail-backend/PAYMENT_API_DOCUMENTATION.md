# Payment Processing API Documentation\n\n## Overview\nComplete payment processing backend for Al-Shuail Dashboard with CRUD operations, financial analytics, receipt generation, and database optimizations.\n\n## Base URL\n```\nhttp://localhost:3001/api/payments\n```\n\n## Authentication\nAll endpoints require valid JWT token in Authorization header:\n```\nAuthorization: Bearer <jwt_token>\n```\n\n## Endpoints\n\n### Basic CRUD Operations\n\n#### Get All Payments\n```http\nGET /api/payments\n```\n\n**Query Parameters:**\n- `status` (optional): Filter by payment status (pending, paid, cancelled, failed, refunded)\n- `member_id` (optional): Filter by member ID\n- `category` (optional): Filter by category (subscription, donation, event, membership, other)\n- `limit` (optional): Number of results per page (default: 50)\n- `offset` (optional): Pagination offset (default: 0)\n\n**Response:**\n```json\n{\n  \"success\": true,\n  \"data\": [\n    {\n      \"id\": \"uuid\",\n      \"payer_id\": \"uuid\",\n      \"amount\": 150.00,\n      \"category\": \"subscription\",\n      \"payment_method\": \"card\",\n      \"status\": \"paid\",\n      \"reference_number\": \"SH-12345678-ABCD\",\n      \"notes\": \"Monthly subscription\",\n      \"created_at\": \"2025-01-15T10:30:00Z\",\n      \"processed_at\": \"2025-01-15T10:35:00Z\"\n    }\n  ],\n  \"pagination\": {\n    \"limit\": 50,\n    \"offset\": 0,\n    \"total\": 100\n  }\n}\n```\n\n#### Create Payment\n```http\nPOST /api/payments\n```\n\n**Request Body:**\n```json\n{\n  \"payer_id\": \"uuid\",\n  \"amount\": 150.00,\n  \"category\": \"subscription\",\n  \"payment_method\": \"card\",\n  \"notes\": \"Monthly subscription payment\"\n}\n```\n\n**Response:**\n```json\n{\n  \"success\": true,\n  \"data\": {\n    \"id\": \"uuid\",\n    \"reference_number\": \"SH-12345678-ABCD\",\n    \"status\": \"pending\",\n    // ... other fields\n  },\n  \"message\": \"تم إنشاء المدفوع بنجاح\"\n}\n```\n\n#### Get Payment by ID\n```http\nGET /api/payments/{id}\n```\n\n**Response:**\n```json\n{\n  \"success\": true,\n  \"data\": {\n    \"id\": \"uuid\",\n    \"payer\": {\n      \"id\": \"uuid\",\n      \"full_name\": \"أحمد محمد\",\n      \"phone\": \"+965 1234 5678\",\n      \"email\": \"ahmed@example.com\",\n      \"membership_number\": \"M001\"\n    },\n    // ... payment details\n  }\n}\n```\n\n#### Update Payment Status\n```http\nPUT /api/payments/{id}/status\n```\n\n**Request Body:**\n```json\n{\n  \"status\": \"paid\"\n}\n```\n\n#### Process Payment\n```http\nPOST /api/payments/{id}/process\n```\n\n**Request Body:**\n```json\n{\n  \"method\": \"card\"\n}\n```\n\n### Member-Specific Operations\n\n#### Get Member Payments\n```http\nGET /api/payments/member/{memberId}\n```\n\n**Query Parameters:**\n- `status` (optional): Filter by status\n- `category` (optional): Filter by category\n- `limit` (optional): Results per page\n- `offset` (optional): Pagination offset\n\n**Response:**\n```json\n{\n  \"success\": true,\n  \"data\": [...],\n  \"summary\": {\n    \"totalPayments\": 12,\n    \"totalAmount\": 1800.00,\n    \"paidAmount\": 1500.00,\n    \"pendingAmount\": 300.00\n  },\n  \"pagination\": {...}\n}\n```\n\n### Analytics and Statistics\n\n#### Get Payment Statistics\n```http\nGET /api/payments/statistics\n```\n\n**Query Parameters:**\n- `startDate` (optional): Start date for analysis (ISO format)\n- `endDate` (optional): End date for analysis (ISO format)\n\n**Response:**\n```json\n{\n  \"success\": true,\n  \"data\": {\n    \"totalPayments\": 150,\n    \"totalAmount\": 45000.00,\n    \"paidAmount\": 42000.00,\n    \"pendingAmount\": 3000.00,\n    \"statusBreakdown\": {\n      \"paid\": 140,\n      \"pending\": 8,\n      \"failed\": 2\n    },\n    \"categoryBreakdown\": {\n      \"subscription\": { \"count\": 100, \"amount\": 35000.00 },\n      \"donation\": { \"count\": 30, \"amount\": 8000.00 }\n    },\n    \"averagePayment\": 300.00,\n    \"successRate\": 93.33\n  },\n  \"period\": {\n    \"startDate\": \"2025-01-01T00:00:00Z\",\n    \"endDate\": \"2025-01-31T23:59:59Z\"\n  }\n}\n```\n\n#### Get Revenue Statistics\n```http\nGET /api/payments/revenue\n```\n\n**Query Parameters:**\n- `period`: Period type (today, week, month, quarter, year) - default: month\n\n**Response:**\n```json\n{\n  \"success\": true,\n  \"data\": {\n    \"period\": \"month\",\n    \"totalRevenue\": 42000.00,\n    \"paymentCount\": 140,\n    \"categoryRevenue\": {\n      \"subscription\": 35000.00,\n      \"donation\": 7000.00\n    },\n    \"averageTransaction\": 300.00,\n    \"comparisonWithPrevious\": {\n      \"previousRevenue\": 38000.00,\n      \"changeAmount\": 4000.00,\n      \"changePercentage\": 10.53,\n      \"trend\": \"up\"\n    }\n  }\n}\n```\n\n#### Get Payments by Category\n```http\nGET /api/payments/categories\n```\n\n**Response:**\n```json\n{\n  \"success\": true,\n  \"data\": {\n    \"categories\": [\n      {\n        \"name\": \"subscription\",\n        \"totalCount\": 100,\n        \"totalAmount\": 35000.00,\n        \"paidCount\": 95,\n        \"paidAmount\": 33250.00,\n        \"percentage\": 77.8\n      }\n    ],\n    \"summary\": {\n      \"totalCategories\": 4,\n      \"totalAmount\": 45000.00,\n      \"totalCount\": 150\n    }\n  }\n}\n```\n\n#### Get Member Contributions\n```http\nGET /api/payments/contributions\n```\n\n**Response:**\n```json\n{\n  \"success\": true,\n  \"data\": {\n    \"topContributors\": [\n      {\n        \"member\": {\n          \"id\": \"uuid\",\n          \"full_name\": \"أحمد محمد\",\n          \"membership_number\": \"M001\"\n        },\n        \"totalAmount\": 2400.00,\n        \"paymentCount\": 8,\n        \"averagePayment\": 300.00,\n        \"lastPayment\": \"2025-01-15T10:30:00Z\"\n      }\n    ],\n    \"totalMembers\": 45,\n    \"totalContributions\": 42000.00,\n    \"averageContribution\": 933.33\n  }\n}\n```\n\n#### Get Overdue Payments\n```http\nGET /api/payments/overdue\n```\n\n**Response:**\n```json\n{\n  \"success\": true,\n  \"data\": {\n    \"overduePayments\": [...],\n    \"summary\": {\n      \"count\": 15,\n      \"totalAmount\": 4500.00,\n      \"ageBreakdown\": {\n        \"30-60days\": { \"count\": 8, \"amount\": 2400.00 },\n        \"60-90days\": { \"count\": 4, \"amount\": 1200.00 },\n        \"90+days\": { \"count\": 3, \"amount\": 900.00 }\n      }\n    }\n  }\n}\n```\n\n### Bulk Operations\n\n#### Bulk Update Payments\n```http\nPOST /api/payments/bulk-update\n```\n\n**Request Body:**\n```json\n{\n  \"updates\": [\n    {\n      \"id\": \"uuid1\",\n      \"status\": \"paid\"\n    },\n    {\n      \"id\": \"uuid2\",\n      \"status\": \"cancelled\"\n    }\n  ]\n}\n```\n\n**Response:**\n```json\n{\n  \"success\": true,\n  \"data\": {\n    \"updated\": [...],\n    \"failed\": [...],\n    \"summary\": {\n      \"total\": 2,\n      \"successful\": 1,\n      \"failed\": 1\n    }\n  },\n  \"message\": \"تم تحديث 1 من 2 مدفوع\"\n}\n```\n\n### Reports and Receipts\n\n#### Generate Financial Report\n```http\nGET /api/payments/report\n```\n\n**Query Parameters:**\n- `period`: Period type (today, week, month, quarter, year) - default: month\n- `includeCharts`: Include chart data (true/false) - default: true\n- `includeMemberStats`: Include member statistics (true/false) - default: true\n- `includeOverdue`: Include overdue payments (true/false) - default: true\n\n**Response:**\n```json\n{\n  \"success\": true,\n  \"data\": {\n    \"generatedAt\": \"2025-01-15T12:00:00Z\",\n    \"period\": \"month\",\n    \"summary\": {...},\n    \"revenue\": {...},\n    \"categories\": {...},\n    \"memberStats\": {...},\n    \"overduePayments\": {...},\n    \"trends\": {\n      \"revenueGrowth\": 10.53,\n      \"paymentVolumeGrowth\": 8.2,\n      \"averagePaymentTrend\": 2.1\n    }\n  }\n}\n```\n\n#### Generate Payment Receipt\n```http\nPOST /api/payments/receipt/{paymentId}\nGET /api/payments/receipt/{paymentId}\n```\n\n**Query Parameters:**\n- `format`: Receipt format (json, pdf, html) - default: json\n- `language`: Language (ar, en) - default: ar\n\n**JSON Response:**\n```json\n{\n  \"success\": true,\n  \"data\": {\n    \"header\": {\n      \"organizationName\": \"جمعية الشعيل الخيرية\",\n      \"receiptNumber\": \"SH-12345678-ABCD\",\n      \"issueDate\": \"15/01/2025\"\n    },\n    \"payer\": {\n      \"name\": \"أحمد محمد\",\n      \"membershipNumber\": \"M001\"\n    },\n    \"payment\": {\n      \"amount\": 150.00,\n      \"amountInWords\": \"مائة وخمسون ريال سعودي\",\n      \"category\": \"اشتراك\",\n      \"referenceNumber\": \"SH-12345678-ABCD\"\n    }\n  }\n}\n```\n\n**PDF Response:**\nReturns PDF file with headers:\n```\nContent-Type: application/pdf\nContent-Disposition: attachment; filename=receipt-SH-12345678-ABCD.pdf\n```\n\n## Payment Categories\n- `subscription`: اشتراك (Minimum 50 SAR, must be multiple of 50)\n- `donation`: تبرع\n- `event`: فعالية (Minimum 10 SAR)\n- `membership`: عضوية\n- `other`: أخرى\n\n## Payment Statuses\n- `pending`: معلق\n- `paid`: مدفوع\n- `cancelled`: ملغي\n- `failed`: فشل\n- `refunded`: مسترد\n\n## Payment Methods\n- `cash`: نقداً\n- `card`: بطاقة ائتمان\n- `transfer`: تحويل بنكي\n- `online`: دفع إلكتروني\n- `check`: شيك\n\n## Reference Number Format\n`SH-[8-digit-timestamp]-[4-char-random]`\n\nExample: `SH-20250116-AB3D`\n\n## Validation Rules\n\n### Payment Amount\n- Must be positive number\n- Maximum: 100,000 SAR\n- For subscriptions: Minimum 50 SAR, must be multiple of 50\n- For events: Minimum 10 SAR\n\n### Member Validation\n- Member must exist and be active\n- Member ID must be valid UUID\n\n### Duplicate Detection\n- Same member, amount, and category within 1-hour window\n\n## Error Responses\n\n```json\n{\n  \"success\": false,\n  \"error\": \"رسالة الخطأ بالعربية\"\n}\n```\n\n### Common Error Messages\n- `المدفوع غير موجود`: Payment not found\n- `العضو غير موجود في النظام`: Member not found\n- `المبلغ يجب أن يكون رقماً موجباً`: Amount must be positive\n- `الحد الأدنى للاشتراك 50 ريال سعودي`: Minimum subscription is 50 SAR\n- `مبلغ الاشتراك يجب أن يكون من مضاعفات الـ 50 ريال`: Subscription must be multiple of 50 SAR\n- `يوجد دفع مماثل مسبقاً لهذا العضو`: Duplicate payment detected\n- `طريقة دفع غير صالحة`: Invalid payment method\n- `حالة غير صالحة`: Invalid status\n\n## Database Schema\n\n### Payments Table\n```sql\nCREATE TABLE payments (\n  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,\n  payer_id UUID REFERENCES members(id),\n  amount DECIMAL(10,2) NOT NULL CHECK (amount > 0 AND amount <= 100000),\n  category VARCHAR(50) CHECK (category IN ('subscription', 'donation', 'event', 'membership', 'other')),\n  payment_method VARCHAR(50),\n  status VARCHAR(20) DEFAULT 'pending' CHECK (status IN ('pending', 'paid', 'cancelled', 'failed', 'refunded')),\n  reference_number VARCHAR(50) UNIQUE,\n  notes TEXT,\n  processed_at TIMESTAMP,\n  due_date DATE,\n  receipt_generated BOOLEAN DEFAULT FALSE,\n  receipt_sent BOOLEAN DEFAULT FALSE,\n  reminder_count INTEGER DEFAULT 0,\n  last_reminder_sent TIMESTAMP,\n  created_at TIMESTAMP DEFAULT NOW(),\n  updated_at TIMESTAMP DEFAULT NOW()\n);\n```\n\n### Database Indexes\n- `idx_payments_payer_id`: Index on payer_id\n- `idx_payments_status`: Index on status\n- `idx_payments_category`: Index on category\n- `idx_payments_created_at`: Index on created_at\n- `idx_payments_reference_number`: Index on reference_number\n- `idx_payments_status_created_at`: Composite index\n- `idx_payments_payer_status`: Composite index\n- `idx_payments_category_status`: Composite index\n\n### Analytics Views\n- `payment_analytics_view`: Comprehensive payment data with member details\n- `monthly_revenue_view`: Monthly revenue breakdown\n- `member_payment_summary_view`: Member contribution summaries\n- `overdue_payments_view`: Overdue payment tracking\n\n## Performance Optimizations\n\n1. **Database Indexes**: Optimized for common query patterns\n2. **Views**: Pre-calculated analytics data\n3. **Audit Logging**: Track all payment changes\n4. **Query Optimization**: Efficient database queries\n5. **Caching**: Built-in caching for frequently accessed data\n\n## Security Features\n\n1. **Input Validation**: All inputs validated and sanitized\n2. **SQL Injection Protection**: Parameterized queries\n3. **Amount Validation**: Business rule enforcement\n4. **Duplicate Detection**: Prevent duplicate payments\n5. **Audit Trail**: Complete change history\n6. **Reference Number**: Unique tracking for all payments\n\n## Testing\n\nRun the payment processing tests:\n```bash\nnpm test -- --grep \"payment\"\n```\n\n## Database Initialization\n\nRun database optimization:\n```bash\nnode src/scripts/initializeDatabase.js\n```\n\n## Support\n\nFor API support or questions, contact the development team.\n\n---\n\n**Generated by Claude Code - Al-Shuail Backend Development Team**\n*Last Updated: January 16, 2025*