<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ø®ØªØ¨Ø§Ø± Ø¥ØµÙ„Ø§Ø­ Ø´Ø¬Ø±Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            direction: rtl;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }
        h1 {
            text-align: center;
            color: #ffd700;
        }
        .test-result {
            margin: 20px 0;
            padding: 15px;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
        }
        .success {
            background: rgba(52, 211, 153, 0.2);
            border-left: 4px solid #10b981;
        }
        .error {
            background: rgba(248, 113, 113, 0.2);
            border-left: 4px solid #ef4444;
        }
        .info {
            background: rgba(96, 165, 250, 0.2);
            border-left: 4px solid #3b82f6;
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #2563eb;
        }
        .members-list {
            max-height: 300px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.2);
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .member-item {
            padding: 10px;
            margin: 5px 0;
            background: rgba(59, 130, 246, 0.2);
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .member-item:hover {
            background: rgba(59, 130, 246, 0.4);
        }
        pre {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            direction: ltr;
            text-align: left;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸŒ³ Ø§Ø®ØªØ¨Ø§Ø± Ø¥ØµÙ„Ø§Ø­ Ø´Ø¬Ø±Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©</h1>

        <div class="test-result info">
            <h3>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</h3>
            <p>Ù‡Ø°Ø§ Ø§Ø®ØªØ¨Ø§Ø± Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø´Ø¬Ø±Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© ØªØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ Ø¨Ø¯ÙˆÙ† Ø£Ø®Ø·Ø§Ø¡ 404</p>
            <p>Ø§Ù„ØªØ§Ø±ÙŠØ®: <span id="test-date"></span></p>
        </div>

        <div class="test-controls">
            <h3>Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ­ÙƒÙ…</h3>
            <button onclick="fetchMembers()">Ø¬Ù„Ø¨ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</button>
            <button onclick="testNoMemberId()">Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ø¯ÙˆÙ† Ù…Ø¹Ø±Ù Ø¹Ø¶Ùˆ (Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©)</button>
            <button onclick="clearResults()">Ù…Ø³Ø­ Ø§Ù„Ù†ØªØ§Ø¦Ø¬</button>
        </div>

        <div id="members-section" style="display:none;">
            <h3>Ø§Ø®ØªØ± Ø¹Ø¶Ùˆ Ù„Ø¹Ø±Ø¶ Ø´Ø¬Ø±Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©</h3>
            <input type="text" id="member-search" placeholder="Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¹Ø¶Ùˆ..." style="width: 100%; padding: 10px; margin: 10px 0; border-radius: 5px; border: none;">
            <div id="members-list" class="members-list"></div>
        </div>

        <div id="test-results"></div>
    </div>

    <script>
        const API_URL = 'https://proshael.onrender.com';
        const LOCAL_API_URL = 'http://localhost:5001';

        // Get auth token
        const getToken = () => {
            // Hardcoded token for testing
            return 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjgxNTJiYmFjLTc5MDYtNGQ2NC04ZDI3LTRhNWNkYWU4N2QzZCIsImVtYWlsIjoiYWRtaW5AYWxzaHVhaWwuY29tIiwicGhvbmUiOiIwNTAwMDAwMDAwIiwicm9sZSI6InN1cGVyX2FkbWluIiwicGVybWlzc2lvbnMiOnsiYWxsX2FjY2VzcyI6dHJ1ZSwibWFuYWdlX3VzZXJzIjp0cnVlLCJtYW5hZ2VfbWVtYmVycyI6dHJ1ZSwibWFuYWdlX2ZpbmFuY2VzIjp0cnVlLCJtYW5hZ2VfZmFtaWx5X3RyZWUiOnRydWUsIm1hbmFnZV9vY2Nhc2lvbnMiOnRydWUsIm1hbmFnZV9pbml0aWF0aXZlcyI6dHJ1ZSwibWFuYWdlX2RpeWFzIjp0cnVlLCJ2aWV3X3JlcG9ydHMiOnRydWUsInN5c3RlbV9zZXR0aW5ncyI6dHJ1ZX0sImlhdCI6MTc1OTEzMTEyNCwiZXhwIjoxNzU5NzM1OTI0fQ.vywShBezKYKShydt33crdRwmK4fhVdJMkF_v-Zv--z4';
        };

        // Set current date
        document.getElementById('test-date').textContent = new Date().toLocaleString('ar-SA');

        function addResult(message, type = 'info') {
            const resultsDiv = document.getElementById('test-results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${type}`;
            resultDiv.innerHTML = `
                <strong>${type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : 'â„¹ï¸'}</strong>
                ${message}
                <br><small>${new Date().toLocaleTimeString('ar-SA')}</small>
            `;
            resultsDiv.appendChild(resultDiv);
        }

        async function fetchMembers() {
            addResult('Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡...', 'info');

            try {
                const response = await fetch(`${API_URL}/api/members`, {
                    headers: {
                        'Authorization': `Bearer ${getToken()}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();

                if (data.success && data.data) {
                    addResult(`ØªÙ… Ø¬Ù„Ø¨ ${data.data.length} Ø¹Ø¶Ùˆ Ø¨Ù†Ø¬Ø§Ø­`, 'success');
                    displayMembers(data.data);
                } else {
                    throw new Error(data.error || 'ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡');
                }
            } catch (error) {
                addResult(`Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡: ${error.message}`, 'error');
            }
        }

        function displayMembers(members) {
            const membersSection = document.getElementById('members-section');
            const membersList = document.getElementById('members-list');

            membersSection.style.display = 'block';
            membersList.innerHTML = '';

            // Take first 20 members
            members.slice(0, 20).forEach(member => {
                const memberDiv = document.createElement('div');
                memberDiv.className = 'member-item';
                memberDiv.innerHTML = `
                    <strong>${member.full_name}</strong><br>
                    <small>Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©: ${member.member_id} | Ø§Ù„Ù‡Ø§ØªÙ: ${member.phone || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</small>
                `;
                memberDiv.onclick = () => testFamilyTree(member.id, member.full_name);
                membersList.appendChild(memberDiv);
            });

            // Add search functionality
            document.getElementById('member-search').oninput = (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const items = membersList.querySelectorAll('.member-item');
                items.forEach(item => {
                    const text = item.textContent.toLowerCase();
                    item.style.display = text.includes(searchTerm) ? 'block' : 'none';
                });
            };
        }

        async function testFamilyTree(memberId, memberName) {
            addResult(`Ø¬Ø§Ø±ÙŠ Ø§Ø®ØªØ¨Ø§Ø± Ø´Ø¬Ø±Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© Ù„Ù„Ø¹Ø¶Ùˆ: ${memberName}`, 'info');

            try {
                // Test visualization endpoint
                const response = await fetch(`${API_URL}/api/family-tree/visualization/${memberId}`, {
                    headers: {
                        'Authorization': `Bearer ${getToken()}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();

                if (data.success) {
                    addResult(`âœ… Ù†Ø¬Ø­ Ø¬Ù„Ø¨ Ø´Ø¬Ø±Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© Ù„Ù„Ø¹Ø¶Ùˆ ${memberName}`, 'success');

                    // Display tree structure
                    const treeInfo = `
                        <strong>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø´Ø¬Ø±Ø©:</strong><br>
                        Ø§Ù„Ø§Ø³Ù…: ${data.data.name}<br>
                        Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©: ${data.data.memberId}<br>
                        Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø·ÙØ§Ù„: ${data.data.children?.length || 0}<br>
                        Ø§Ù„Ø²ÙˆØ¬/Ø§Ù„Ø²ÙˆØ¬Ø©: ${data.data.spouse?.name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
                    `;
                    addResult(treeInfo, 'info');
                } else {
                    throw new Error(data.error || 'ÙØ´Ù„ Ø¬Ù„Ø¨ Ø´Ø¬Ø±Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©');
                }
            } catch (error) {
                addResult(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø´Ø¬Ø±Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©: ${error.message}`, 'error');
            }
        }

        async function testNoMemberId() {
            addResult('Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙˆØµÙˆÙ„ Ø¨Ø¯ÙˆÙ† Ù…Ø¹Ø±Ù Ø¹Ø¶Ùˆ (Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©)', 'info');

            try {
                // This was causing 404 before the fix
                const response = await fetch(`${API_URL}/api/family-tree/visualization/null`, {
                    headers: {
                        'Authorization': `Bearer ${getToken()}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.status === 404) {
                    addResult('âœ… Ø§Ù„Ø®Ø·Ø£ 404 Ù…ØªÙˆÙ‚Ø¹ ÙˆÙ…Ø¹Ø§Ù„Ø¬ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ Ø¹Ù†Ø¯Ù…Ø§ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¹Ø±Ù Ø¹Ø¶Ùˆ', 'success');
                    addResult('Ø§Ù„Ø­Ù„: ÙŠØªÙ… Ø§Ù„Ø¢Ù† Ø¹Ø±Ø¶ ÙˆØ§Ø¬Ù‡Ø© Ø§Ø®ØªÙŠØ§Ø± Ø¹Ø¶Ùˆ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ Ø´Ø¬Ø±Ø© ÙØ§Ø±ØºØ©', 'info');
                } else {
                    const data = await response.json();
                    addResult(`Ø­Ø§Ù„Ø© ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹Ø©: ${response.status} - ${JSON.stringify(data)}`, 'error');
                }
            } catch (error) {
                addResult(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±: ${error.message}`, 'error');
            }

            // Test the new member endpoint
            addResult('Ø§Ø®ØªØ¨Ø§Ø± Ù†Ù‚Ø·Ø© Ø§Ù„Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø¹Ø¶Ùˆ...', 'info');
            try {
                const response = await fetch(`${API_URL}/api/family-tree/member/8152bbac-7906-4d64-8d27-4a5cdae87d3d`, {
                    headers: {
                        'Authorization': `Bearer ${getToken()}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        addResult('âœ… Ù†Ù‚Ø·Ø© Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¹Ø¶Ùˆ ØªØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­', 'success');
                    }
                } else {
                    addResult(`Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©: ${response.status}`, 'error');
                }
            } catch (error) {
                addResult(`Ø®Ø·Ø£ ÙÙŠ Ø§Ø®ØªØ¨Ø§Ø± Ù†Ù‚Ø·Ø© Ø§Ù„Ù†Ù‡Ø§ÙŠØ©: ${error.message}`, 'error');
            }
        }

        function clearResults() {
            document.getElementById('test-results').innerHTML = '';
            document.getElementById('members-section').style.display = 'none';
            addResult('ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ù†ØªØ§Ø¦Ø¬', 'info');
        }

        // Auto-run basic test
        window.onload = () => {
            addResult('Ù…Ø±Ø­Ø¨Ø§Ù‹! Ø§Ø®ØªØ¨Ø§Ø± Ø¥ØµÙ„Ø§Ø­ Ø´Ø¬Ø±Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© Ø¬Ø§Ù‡Ø²', 'success');
            addResult('Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©: ÙƒØ§Ù† Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø´Ø¬Ø±Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© ÙÙŠ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ ÙŠØ³Ø¨Ø¨ Ø®Ø·Ø£ 404', 'info');
            addResult('Ø§Ù„Ø­Ù„ Ø§Ù„Ù…Ø·Ø¨Ù‚: Ø¥Ø¶Ø§ÙØ© ÙˆØ§Ø¬Ù‡Ø© Ø§Ø®ØªÙŠØ§Ø± Ø¹Ø¶Ùˆ Ø¹Ù†Ø¯ Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ù…Ø¹Ø±Ù Ø¹Ø¶Ùˆ', 'success');
        };
    </script>
</body>
</html>