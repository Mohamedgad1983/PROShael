# Al-Shuail Backend API - Railway Configuration
# Production deployment configuration for Node.js backend

[build]
builder = "DOCKERFILE"
dockerfilePath = "alshuail-backend/Dockerfile"

[deploy]
startCommand = "node server.js"
healthcheckPath = "/health"
healthcheckTimeout = 30
restartPolicyType = "ON_FAILURE"
restartPolicyMaxRetries = 3

# Build context configuration
[build.context]
root = "alshuail-backend"

# Environment variables for Railway deployment
[environments.production.variables]
NODE_ENV = "production"
PORT = "3001"
LOG_LEVEL = "warn"
RATE_LIMIT_WINDOW_MS = "900000"
RATE_LIMIT_MAX_REQUESTS = "100"

[environments.staging.variables]
NODE_ENV = "staging"
PORT = "3001"
LOG_LEVEL = "info"
RATE_LIMIT_WINDOW_MS = "600000"
RATE_LIMIT_MAX_REQUESTS = "150"

# Resource limits
[deploy.resources]
memory = "512Mi"
cpu = "500m"

# Scaling configuration
[deploy.scaling]
minReplicas = 1
maxReplicas = 3
cpuThreshold = 80
memoryThreshold = 80

# Health check configuration
[deploy.healthcheck]
path = "/health"
interval = "30s"
timeout = "10s"
retries = 3
startPeriod = "60s"

# Volume configuration for uploads and logs
[[deploy.volumes]]
name = "uploads"
path = "/app/uploads"
size = "1Gi"

[[deploy.volumes]]
name = "logs"
path = "/app/logs"
size = "500Mi"

# Network configuration
[deploy.networking]
allowedOrigins = [
  "https://alshuail.com",
  "https://staging.alshuail.com",
  "https://*.vercel.app"
]

# Database connection settings
[database]
provider = "postgresql"
version = "15"
connectionPooling = true
maxConnections = 20
idleTimeout = "10m"

# Redis configuration
[redis]
version = "7"
maxMemory = "256mb"
evictionPolicy = "allkeys-lru"

# Monitoring and observability
[observability]
metrics = true
logs = true
traces = false

[observability.metrics]
enabled = true
interval = "30s"
retention = "30d"

[observability.logs]
enabled = true
level = "info"
retention = "7d"
format = "json"

# Security settings
[security]
forceHttps = true
hsts = true
hstsMaxAge = 31536000
hstsIncludeSubdomains = true

# Content Security Policy for API responses
[security.csp]
enabled = true
defaultSrc = ["'self'"]
connectSrc = ["'self'", "https://*.supabase.co"]
frameSrc = ["'none'"]
objectSrc = ["'none'"]

# CORS configuration
[security.cors]
enabled = true
credentials = true
maxAge = 86400

# Backup configuration
[backup]
enabled = true
schedule = "0 2 * * *"
retention = "30d"
compression = true

# Performance optimization
[performance]
compression = true
compressionLevel = 6
staticFileMaxAge = "1d"
apiResponseCaching = false

# Auto-deployment configuration
[deployment]
autoDetect = true
buildCommand = "npm ci --only=production"
startCommand = "node server.js"
ignoreCommand = "[ \"$RAILWAY_ENVIRONMENT\" != \"production\" ]"

# Branch-specific deployments
[deployment.branches]
main = "production"
develop = "staging"

# Environment-specific settings
[environments.production]
name = "Al-Shuail Production"
domain = "api.alshuail.com"

[environments.staging]
name = "Al-Shuail Staging"
domain = "staging-api.alshuail.com"

# Webhook configuration for CI/CD integration
[webhooks]
enabled = true
events = ["deploy.success", "deploy.failed", "build.success", "build.failed"]

# Secrets management
[secrets]
# These should be set via Railway dashboard or CLI
# SUPABASE_URL
# SUPABASE_KEY
# JWT_SECRET
# REDIS_PASSWORD

# Custom startup commands
[startup]
preCommands = [
  "echo 'Starting Al-Shuail Backend API...'",
  "node healthcheck.js"
]

postCommands = [
  "echo 'Backend API started successfully'",
  "echo 'Health check endpoint: /health'",
  "echo 'API documentation: /api/docs'"
]

# Migration configuration
[migrations]
enabled = true
command = "npm run migrate"
timeout = "300s"

# Backup and restore
[backup.database]
enabled = true
schedule = "0 3 * * *"
retention = "14d"

[backup.volumes]
enabled = true
schedule = "0 4 * * *"
retention = "7d"

# Monitoring alerts
[alerts]
enabled = true

[alerts.cpu]
threshold = 85
duration = "5m"

[alerts.memory]
threshold = 90
duration = "5m"

[alerts.disk]
threshold = 85
duration = "5m"

[alerts.response_time]
threshold = "2s"
duration = "3m"

[alerts.error_rate]
threshold = 5
duration = "2m"

# Custom domains
[domains]
production = ["api.alshuail.com"]
staging = ["staging-api.alshuail.com"]

# SSL/TLS configuration
[ssl]
enabled = true
forceRedirect = true
hsts = true