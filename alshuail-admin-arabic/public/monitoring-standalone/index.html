<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة مراقبة الأعضاء المتقدمة - Al-Shuail</title>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' cdn.jsdelivr.net cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' fonts.googleapis.com cdnjs.cloudflare.com; font-src fonts.googleapis.com fonts.gstatic.com cdnjs.cloudflare.com; connect-src 'self' https://proshael.onrender.com; img-src 'self' data:;">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Cairo', 'Tajawal', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .dashboard-container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        /* Header Section */
        .dashboard-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 30px 40px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-title i {
            font-size: 2rem;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .header-title h1 {
            font-size: 2rem;
            font-weight: 700;
        }

        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .btn-header {
            padding: 12px 25px;
            border: 2px solid white;
            background: transparent;
            color: white;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-header:hover {
            background: white;
            color: #667eea;
            transform: translateY(-2px);
        }

        .notification-bell {
            position: relative;
            cursor: pointer;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            left: -5px;
            background: #ff4757;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
        }

        /* Statistics Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            padding: 30px 40px;
            background: #f8f9fa;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 20px;
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 5px;
            height: 100%;
            background: var(--card-color);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--card-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
        }

        .stat-info h3 {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .stat-info .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--card-color);
        }

        .stat-trend {
            font-size: 0.8rem;
            color: #28a745;
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 5px;
        }

        .stat-trend.down {
            color: #dc3545;
        }

        /* Charts Section */
        .charts-section {
            padding: 30px 40px;
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }

        .chart-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .chart-card h3 {
            margin-bottom: 20px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Filter Section */
        .filter-section {
            padding: 30px 40px;
            background: white;
        }

        .filter-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
            flex-wrap: wrap;
        }

        .filter-tab {
            padding: 12px 25px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            color: #666;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .filter-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-group label {
            font-weight: 600;
            color: #555;
            font-size: 0.9rem;
        }

        .filter-input, .filter-select {
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-family: 'Cairo', sans-serif;
            transition: all 0.3s;
        }

        .filter-input:focus, .filter-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .filter-actions {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: 'Cairo', sans-serif;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-outline {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
        }

        .btn-outline:hover {
            background: #667eea;
            color: white;
        }

        /* Bulk Actions Bar */
        .bulk-actions-bar {
            position: fixed;
            bottom: -100px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 20px 40px;
            border-radius: 15px;
            box-shadow: 0 -5px 30px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 20px;
            z-index: 1000;
            transition: all 0.3s;
            flex-wrap: wrap;
        }

        .bulk-actions-bar.active {
            bottom: 30px;
        }

        .selected-count {
            font-weight: 700;
            color: #667eea;
            font-size: 1.1rem;
        }

        /* Data Table */
        .table-section {
            padding: 30px 40px;
            background: white;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .table-header h2 {
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .table-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .table-responsive {
            overflow-x: auto;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        th {
            padding: 15px;
            text-align: right;
            font-weight: 600;
            white-space: nowrap;
        }

        th.sortable {
            cursor: pointer;
            user-select: none;
        }

        th.sortable:hover {
            background: rgba(255,255,255,0.1);
        }

        tbody tr {
            border-bottom: 1px solid #e9ecef;
            transition: all 0.3s;
        }

        tbody tr:hover {
            background: #f8f9fa;
        }

        tbody tr.selected {
            background: #e3f2fd;
        }

        td {
            padding: 15px;
            text-align: right;
        }

        .member-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .member-number {
            font-weight: 700;
            color: #667eea;
        }

        .member-name {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .member-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-suspended {
            background: #f8d7da;
            color: #721c24;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .payment-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .payment-paid {
            background: #d4edda;
            color: #155724;
        }

        .payment-overdue {
            background: #f8d7da;
            color: #721c24;
        }

        .payment-partial {
            background: #fff3cd;
            color: #856404;
        }

        .amount-display {
            font-weight: 700;
        }

        .amount-positive {
            color: #28a745;
        }

        .amount-negative {
            color: #dc3545;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn-action {
            padding: 8px 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            color: white;
            font-size: 0.9rem;
        }

        .btn-view {
            background: #17a2b8;
        }

        .btn-view:hover {
            background: #138496;
            transform: scale(1.1);
        }

        .btn-suspend {
            background: #ffc107;
        }

        .btn-suspend:hover {
            background: #e0a800;
            transform: scale(1.1);
        }

        .btn-notify {
            background: #667eea;
        }

        .btn-notify:hover {
            background: #5568d3;
            transform: scale(1.1);
        }

        .btn-whatsapp {
            background: #25D366;
        }

        .btn-whatsapp:hover {
            background: #1eaa52;
            transform: scale(1.1);
        }

        .btn-history {
            background: #6c757d;
        }

        .btn-history:hover {
            background: #5a6268;
            transform: scale(1.1);
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .page-btn {
            padding: 10px 15px;
            border: 2px solid #e9ecef;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .page-btn:hover {
            border-color: #667eea;
            color: #667eea;
        }

        .page-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
        }

        .modal-header h3 {
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #999;
            transition: all 0.3s;
        }

        .close-modal:hover {
            color: #dc3545;
            transform: rotate(90deg);
        }

        .modal-body {
            margin-bottom: 25px;
        }

        .modal-footer {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-family: 'Cairo', sans-serif;
            transition: all 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        textarea.form-control {
            resize: vertical;
            min-height: 100px;
        }


        /* Login Modal Specific Styles */
        .login-modal {
            max-width: 450px;
            text-align: center;
        }

        .login-header {
            margin-bottom: 30px;
        }

        .login-logo {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            color: white;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        .login-header h2 {
            color: #333;
            margin-bottom: 5px;
            font-size: 1.8rem;
        }

        .login-header p {
            color: #999;
            font-size: 0.9rem;
        }

        #loginForm {
            text-align: right;
        }

        #loginForm .form-group label {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-weight: normal;
            margin: 0;
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .login-error {
            background: #ffe6e6;
            border: 1px solid #ff4d4d;
            border-radius: 10px;
            padding: 12px 15px;
            margin-bottom: 15px;
            color: #cc0000;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
        }

        .login-error i {
            font-size: 1.2rem;
        }

        .btn-login {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-login:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }

        .btn-login:active {
            transform: translateY(0);
        }

        .btn-login:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-login .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* Timeline Styles */
        .timeline {
            position: relative;
            padding: 20px 0;
        }

        .timeline::before {
            content: '';
            position: absolute;
            right: 20px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #e9ecef;
        }

        .timeline-item {
            position: relative;
            padding: 0 50px 30px 0;
        }

        .timeline-dot {
            position: absolute;
            right: 11px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: white;
            border: 4px solid #667eea;
        }

        .timeline-content {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
        }

        .timeline-date {
            font-size: 0.85rem;
            color: #999;
            margin-bottom: 5px;
        }

        .timeline-text {
            color: #333;
        }

        /* Loading Spinner */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }


        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 3000;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }

        .loading-content {
            text-align: center;
            color: white;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            margin: 0 auto 20px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        .loading-content p {
            font-size: 1.2rem;
            font-weight: 600;
        }

        /* Toast Notifications */
        .error-toast, .success-toast {
            position: fixed;
            top: 80px;
            right: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 2500;
            animation: slideInRight 0.3s ease;
            min-width: 300px;
            max-width: 500px;
        }

        .error-toast {
            border-right: 4px solid #dc3545;
        }

        .success-toast {
            border-right: 4px solid #28a745;
        }

        .error-toast i {
            color: #dc3545;
            font-size: 1.3rem;
        }

        .success-toast i {
            color: #28a745;
            font-size: 1.3rem;
        }

        .error-toast span, .success-toast span {
            flex: 1;
            font-size: 0.95rem;
            color: #333;
        }

        .toast-close {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: #999;
            padding: 0;
            transition: color 0.3s;
        }

        .toast-close:hover {
            color: #333;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        /* Responsive Design */
        @media (max-width: 768px) {
            .dashboard-header {
                padding: 20px;
            }

            .header-title h1 {
                font-size: 1.5rem;
            }

            .stats-grid {
                padding: 20px;
                grid-template-columns: 1fr;
            }

            .charts-section {
                grid-template-columns: 1fr;
                padding: 20px;
            }

            .filter-section, .table-section {
                padding: 20px;
            }

            .filter-grid {
                grid-template-columns: 1fr;
            }

            .bulk-actions-bar {
                padding: 15px 20px;
            }

            .table-responsive {
                font-size: 0.85rem;
            }

            th, td {
                padding: 10px;
            }

            .modal-content {
                padding: 25px;
            }
        }

        /* Quick Actions Sidebar */
        .quick-actions {
            position: fixed;
            right: -300px;
            top: 50%;
            transform: translateY(-50%);
            width: 280px;
            background: white;
            border-radius: 20px 0 0 20px;
            box-shadow: -5px 0 30px rgba(0,0,0,0.2);
            padding: 25px;
            transition: all 0.3s;
            z-index: 1500;
        }

        .quick-actions.active {
            right: 0;
        }

        .quick-actions-toggle {
            position: absolute;
            left: -50px;
            top: 50%;
            transform: translateY(-50%);
            width: 50px;
            height: 50px;
            background: #667eea;
            border: none;
            border-radius: 10px 0 0 10px;
            color: white;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s;
        }

        .quick-actions-toggle:hover {
            background: #5568d3;
        }

        .quick-action-item {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            border: 2px solid #e9ecef;
        }

        .quick-action-item:hover {
            background: #f8f9fa;
            border-color: #667eea;
        }

        .quick-action-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }
    </style>
</head>
<body>
    <!-- Dashboard Container -->
    <div class="dashboard-container">
        <!-- Header -->
        <div class="dashboard-header">
            <div class="header-title">
                <i class="fas fa-users-cog"></i>
                <h1>لوحة مراقبة الأعضاء المتقدمة</h1>
            </div>
            <div class="header-actions">
                <button class="btn-header" onclick="exportToExcel()">
                    <i class="fas fa-file-excel"></i>
                    تصدير Excel
                </button>
                <button class="btn-header" onclick="printReport()">
                    <i class="fas fa-print"></i>
                    طباعة
                </button>
                <button class="btn-header" onclick="refreshData()">
                    <i class="fas fa-sync-alt"></i>
                    تحديث
                </button>
                <div class="notification-bell" onclick="toggleNotifications()">
                    <i class="fas fa-bell" style="font-size: 1.5rem;"></i>
                    <span class="notification-badge">3</span>
                </div>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="stats-grid">
            <div class="stat-card" style="--card-color: #667eea;">
                <div class="stat-icon">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-info">
                    <h3>إجمالي الأعضاء</h3>
                    <div class="stat-number">100</div>
                    <div class="stat-trend">
                        <i class="fas fa-arrow-up"></i>
                        +5% هذا الشهر
                    </div>
                </div>
            </div>

            <div class="stat-card" style="--card-color: #28a745;">
                <div class="stat-icon">
                    <i class="fas fa-user-check"></i>
                </div>
                <div class="stat-info">
                    <h3>أعضاء نشطون</h3>
                    <div class="stat-number">95</div>
                    <div class="stat-trend">
                        <i class="fas fa-arrow-up"></i>
                        +2% هذا الأسبوع
                    </div>
                </div>
            </div>

            <div class="stat-card" style="--card-color: #ffc107;">
                <div class="stat-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="stat-info">
                    <h3>متأخرات مالية</h3>
                    <div class="stat-number">12</div>
                    <div class="stat-trend down">
                        <i class="fas fa-arrow-down"></i>
                        -3 من الأسبوع الماضي
                    </div>
                </div>
            </div>

            <div class="stat-card" style="--card-color: #dc3545;">
                <div class="stat-icon">
                    <i class="fas fa-user-slash"></i>
                </div>
                <div class="stat-info">
                    <h3>أعضاء موقوفون</h3>
                    <div class="stat-number">5</div>
                    <div class="stat-trend">
                        <i class="fas fa-minus"></i>
                        لا تغيير
                    </div>
                </div>
            </div>

            <div class="stat-card" style="--card-color: #17a2b8;">
                <div class="stat-icon">
                    <i class="fas fa-money-bill-wave"></i>
                </div>
                <div class="stat-info">
                    <h3>إجمالي الاشتراكات</h3>
                    <div class="stat-number">50,000</div>
                    <div class="stat-trend">
                        <i class="fas fa-arrow-up"></i>
                        +15% هذا الشهر
                    </div>
                </div>
            </div>

            <div class="stat-card" style="--card-color: #6c757d;">
                <div class="stat-icon">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stat-info">
                    <h3>اشتراكات منتهية</h3>
                    <div class="stat-number">8</div>
                    <div class="stat-trend down">
                        <i class="fas fa-arrow-up"></i>
                        تحتاج تجديد
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="charts-section">
            <div class="chart-card">
                <h3>
                    <i class="fas fa-chart-line"></i>
                    الاشتراكات حسب الشهر
                </h3>
                <canvas id="subscriptionChart"></canvas>
            </div>
            <div class="chart-card">
                <h3>
                    <i class="fas fa-chart-pie"></i>
                    توزيع حسب الفخذ
                </h3>
                <canvas id="branchChart"></canvas>
            </div>
        </div>

        <!-- Filter Section -->
        <div class="filter-section">
            <div class="filter-tabs">
                <button class="filter-tab active" onclick="switchTab('basic')">
                    <i class="fas fa-filter"></i>
                    فلترة أساسية
                </button>
                <button class="filter-tab" onclick="switchTab('advanced')">
                    <i class="fas fa-sliders-h"></i>
                    فلترة متقدمة
                </button>
                <button class="filter-tab" onclick="switchTab('saved')">
                    <i class="fas fa-bookmark"></i>
                    فلاتر محفوظة
                </button>
            </div>

            <div id="basicFilters" class="filter-content">
                <div class="filter-grid">
                    <div class="filter-group">
                        <label>رقم العضوية</label>
                        <input type="text" class="filter-input" placeholder="ابحث برقم العضوية...">
                    </div>
                    <div class="filter-group">
                        <label>اسم العضو</label>
                        <input type="text" class="filter-input" placeholder="ابحث بالاسم...">
                    </div>
                    <div class="filter-group">
                        <label>رقم الجوال</label>
                        <input type="text" class="filter-input" placeholder="+965...">
                    </div>
                    <div class="filter-group">
                        <label>الفخذ</label>
                        <select class="filter-select">
                            <option>الكل</option>
                            <option>رشود</option>
                            <option>رشيد</option>
                            <option>العقاب</option>
                            <option>الشبيعان</option>
                            <option>الدغيش</option>
                            <option>الشامخ</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>حالة العضو</label>
                        <select class="filter-select">
                            <option>الكل</option>
                            <option>نشط</option>
                            <option>موقوف</option>
                            <option>معلق</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>الحالة المالية</label>
                        <select class="filter-select">
                            <option>الكل</option>
                            <option>مدفوع</option>
                            <option>متأخر</option>
                            <option>جزئي</option>
                        </select>
                    </div>
                </div>
                <div class="filter-actions">
                    <button class="btn btn-primary">
                        <i class="fas fa-search"></i>
                        بحث
                    </button>
                    <button class="btn btn-secondary">
                        <i class="fas fa-redo"></i>
                        إعادة تعيين
                    </button>
                    <button class="btn btn-outline">
                        <i class="fas fa-save"></i>
                        حفظ الفلتر
                    </button>
                </div>
            </div>
        </div>

        <!-- Data Table -->
        <div class="table-section">
            <div class="table-header">
                <h2>
                    <i class="fas fa-table"></i>
                    قائمة الأعضاء
                    <span style="color: #999; font-size: 0.9rem;">(100 عضو)</span>
                </h2>
                <div class="table-controls">
                    <button class="btn btn-success" onclick="selectAll()">
                        <i class="fas fa-check-double"></i>
                        تحديد الكل
                    </button>
                    <button class="btn btn-secondary" onclick="deselectAll()">
                        <i class="fas fa-times"></i>
                        إلغاء التحديد
                    </button>
                </div>
            </div>

            <div class="table-responsive">
                <table id="membersTable">
                    <thead>
                        <tr>
                            <th><input type="checkbox" class="member-checkbox" onchange="toggleSelectAll(this)"></th>
                            <th class="sortable" onclick="sortTable(1)">رقم العضوية <i class="fas fa-sort"></i></th>
                            <th class="sortable" onclick="sortTable(2)">اسم العضو <i class="fas fa-sort"></i></th>
                            <th>رقم الجوال</th>
                            <th class="sortable" onclick="sortTable(4)">الفخذ <i class="fas fa-sort"></i></th>
                            <th>حالة العضو</th>
                            <th>الحالة المالية</th>
                            <th class="sortable" onclick="sortTable(7)">الرصيد الحالي <i class="fas fa-sort"></i></th>
                            <th>المبلغ المطلوب</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Sample Data Rows -->
                        <tr>
                            <td><input type="checkbox" class="member-checkbox" onchange="updateSelection()"></td>
                            <td><span class="member-number">SH-0001</span></td>
                            <td>
                                <div class="member-name">
                                    <div class="member-avatar">م</div>
                                    <span>محمد عبدالله الشعيل</span>
                                </div>
                            </td>
                            <td dir="ltr">+965 9999 8888</td>
                            <td>رشود</td>
                            <td><span class="status-badge status-active"><i class="fas fa-check-circle"></i> نشط</span></td>
                            <td><span class="payment-badge payment-paid">مدفوع</span></td>
                            <td><span class="amount-display amount-positive">+500 ر.س</span></td>
                            <td>0 ر.س</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn-action btn-view" onclick="viewMember(1)" title="عرض">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn-action btn-history" onclick="showHistory(1)" title="السجل">
                                        <i class="fas fa-history"></i>
                                    </button>
                                    <button class="btn-action btn-notify" onclick="notifyMember(1)" title="إشعار">
                                        <i class="fas fa-bell"></i>
                                    </button>
                                    <button class="btn-action btn-whatsapp" onclick="whatsappMember(1)" title="واتساب">
                                        <i class="fab fa-whatsapp"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>

                        <tr>
                            <td><input type="checkbox" class="member-checkbox" onchange="updateSelection()"></td>
                            <td><span class="member-number">SH-0002</span></td>
                            <td>
                                <div class="member-name">
                                    <div class="member-avatar">أ</div>
                                    <span>أحمد خالد الشعيل</span>
                                </div>
                            </td>
                            <td dir="ltr">+965 9888 7777</td>
                            <td>رشيد</td>
                            <td><span class="status-badge status-active"><i class="fas fa-check-circle"></i> نشط</span></td>
                            <td><span class="payment-badge payment-overdue">متأخر</span></td>
                            <td><span class="amount-display amount-negative">-200 ر.س</span></td>
                            <td>200 ر.س</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn-action btn-view" onclick="viewMember(2)" title="عرض">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn-action btn-history" onclick="showHistory(2)" title="السجل">
                                        <i class="fas fa-history"></i>
                                    </button>
                                    <button class="btn-action btn-notify" onclick="notifyMember(2)" title="إشعار">
                                        <i class="fas fa-bell"></i>
                                    </button>
                                    <button class="btn-action btn-whatsapp" onclick="whatsappMember(2)" title="واتساب">
                                        <i class="fab fa-whatsapp"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>

                        <tr>
                            <td><input type="checkbox" class="member-checkbox" onchange="updateSelection()"></td>
                            <td><span class="member-number">SH-0003</span></td>
                            <td>
                                <div class="member-name">
                                    <div class="member-avatar">س</div>
                                    <span>سعد فهد الشعيل</span>
                                </div>
                            </td>
                            <td dir="ltr">+965 9777 6666</td>
                            <td>العقاب</td>
                            <td><span class="status-badge status-suspended"><i class="fas fa-ban"></i> موقوف</span></td>
                            <td><span class="payment-badge payment-overdue">متأخر</span></td>
                            <td><span class="amount-display amount-negative">-800 ر.س</span></td>
                            <td>800 ر.س</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn-action btn-view" onclick="viewMember(3)" title="عرض">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn-action btn-history" onclick="showHistory(3)" title="السجل">
                                        <i class="fas fa-history"></i>
                                    </button>
                                    <button class="btn-action btn-suspend" onclick="activateMember(3)" title="تنشيط">
                                        <i class="fas fa-user-check"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>

                        <tr>
                            <td><input type="checkbox" class="member-checkbox" onchange="updateSelection()"></td>
                            <td><span class="member-number">SH-0004</span></td>
                            <td>
                                <div class="member-name">
                                    <div class="member-avatar">ف</div>
                                    <span>فيصل عمر الشعيل</span>
                                </div>
                            </td>
                            <td dir="ltr">+965 9666 5555</td>
                            <td>الشبيعان</td>
                            <td><span class="status-badge status-pending"><i class="fas fa-clock"></i> معلق</span></td>
                            <td><span class="payment-badge payment-partial">جزئي</span></td>
                            <td><span class="amount-display amount-negative">-100 ر.س</span></td>
                            <td>100 ر.س</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn-action btn-view" onclick="viewMember(4)" title="عرض">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn-action btn-history" onclick="showHistory(4)" title="السجل">
                                        <i class="fas fa-history"></i>
                                    </button>
                                    <button class="btn-action btn-notify" onclick="notifyMember(4)" title="إشعار">
                                        <i class="fas fa-bell"></i>
                                    </button>
                                    <button class="btn-action btn-whatsapp" onclick="whatsappMember(4)" title="واتساب">
                                        <i class="fab fa-whatsapp"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>

                        <tr>
                            <td><input type="checkbox" class="member-checkbox" onchange="updateSelection()"></td>
                            <td><span class="member-number">SH-0005</span></td>
                            <td>
                                <div class="member-name">
                                    <div class="member-avatar">ع</div>
                                    <span>عبدالرحمن ناصر الشعيل</span>
                                </div>
                            </td>
                            <td dir="ltr">+965 9555 4444</td>
                            <td>الدغيش</td>
                            <td><span class="status-badge status-active"><i class="fas fa-check-circle"></i> نشط</span></td>
                            <td><span class="payment-badge payment-paid">مدفوع</span></td>
                            <td><span class="amount-display amount-positive">+300 ر.س</span></td>
                            <td>0 ر.س</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn-action btn-view" onclick="viewMember(5)" title="عرض">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn-action btn-history" onclick="showHistory(5)" title="السجل">
                                        <i class="fas fa-history"></i>
                                    </button>
                                    <button class="btn-action btn-notify" onclick="notifyMember(5)" title="إشعار">
                                        <i class="fas fa-bell"></i>
                                    </button>
                                    <button class="btn-action btn-whatsapp" onclick="whatsappMember(5)" title="واتساب">
                                        <i class="fab fa-whatsapp"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="pagination">
                <button class="page-btn"><i class="fas fa-angle-double-right"></i></button>
                <button class="page-btn"><i class="fas fa-angle-right"></i></button>
                <button class="page-btn active">1</button>
                <button class="page-btn">2</button>
                <button class="page-btn">3</button>
                <button class="page-btn">4</button>
                <button class="page-btn">5</button>
                <button class="page-btn"><i class="fas fa-angle-left"></i></button>
                <button class="page-btn"><i class="fas fa-angle-double-left"></i></button>
            </div>
        </div>
    </div>

    <!-- Bulk Actions Bar -->
    <div class="bulk-actions-bar" id="bulkActionsBar">
        <span class="selected-count">
            <i class="fas fa-check-circle"></i>
            تم تحديد <strong id="selectedCount">0</strong> عضو
        </span>
        <button class="btn btn-primary" onclick="bulkNotify()">
            <i class="fas fa-bell"></i>
            إرسال إشعار
        </button>
        <button class="btn btn-success" onclick="bulkWhatsapp()">
            <i class="fab fa-whatsapp"></i>
            واتساب جماعي
        </button>
        <button class="btn btn-secondary" onclick="bulkExport()">
            <i class="fas fa-download"></i>
            تصدير المحدد
        </button>
        <button class="btn btn-outline" onclick="deselectAll()">
            <i class="fas fa-times"></i>
            إلغاء
        </button>
    </div>

    <!-- Quick Actions Sidebar -->
    <div class="quick-actions" id="quickActions">
        <button class="quick-actions-toggle" onclick="toggleQuickActions()">
            <i class="fas fa-bolt"></i>
        </button>
        <h3 style="margin-bottom: 20px; color: #333;">
            <i class="fas fa-lightning-bolt"></i>
            إجراءات سريعة
        </h3>
        <div class="quick-action-item" onclick="addNewMember()">
            <div class="quick-action-icon">
                <i class="fas fa-user-plus"></i>
            </div>
            <span>إضافة عضو جديد</span>
        </div>
        <div class="quick-action-item" onclick="sendBulkNotifications()">
            <div class="quick-action-icon">
                <i class="fas fa-bell"></i>
            </div>
            <span>إرسال إشعارات جماعية</span>
        </div>
        <div class="quick-action-item" onclick="generateReport()">
            <div class="quick-action-icon">
                <i class="fas fa-file-alt"></i>
            </div>
            <span>إنشاء تقرير</span>
        </div>
        <div class="quick-action-item" onclick="showOverdue()">
            <div class="quick-action-icon">
                <i class="fas fa-exclamation-circle"></i>
            </div>
            <span>عرض المتأخرات</span>
        </div>
        <div class="quick-action-item" onclick="showExpiring()">
            <div class="quick-action-icon">
                <i class="fas fa-clock"></i>
            </div>
            <span>اشتراكات منتهية</span>
        </div>
    </div>


    <!-- Login Modal -->
    <div class="modal active" id="loginModal">
        <div class="modal-content login-modal">
            <div class="login-header">
                <div class="login-logo">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <h2>تسجيل الدخول</h2>
                <p>لوحة مراقبة الأعضاء - Al-Shuail</p>
            </div>
            <form id="loginForm" onsubmit="event.preventDefault(); login();">
                <div class="form-group">
                    <label for="loginEmail">
                        <i class="fas fa-envelope"></i>
                        البريد الإلكتروني
                    </label>
                    <input type="email" id="loginEmail" class="form-control" required
                           placeholder="admin@alshuail.com" autocomplete="email">
                </div>
                <div class="form-group">
                    <label for="loginPassword">
                        <i class="fas fa-lock"></i>
                        كلمة المرور
                    </label>
                    <input type="password" id="loginPassword" class="form-control" required
                           placeholder="••••••••" autocomplete="current-password">
                </div>
                <div class="form-group checkbox-group">
                    <label>
                        <input type="checkbox" id="rememberMe">
                        <span>تذكرني</span>
                    </label>
                </div>
                <div id="loginError" class="login-error" style="display: none;">
                    <i class="fas fa-exclamation-circle"></i>
                    <span id="loginErrorMessage"></span>
                </div>
                <button type="submit" class="btn btn-login" id="loginButton">
                    <i class="fas fa-sign-in-alt"></i>
                    <span id="loginButtonText">دخول</span>
                </button>
            </form>
        </div>
    </div>
    <!-- Member History Modal -->
    <div class="modal" id="historyModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>
                    <i class="fas fa-history"></i>
                    سجل العضو
                </h3>
                <button class="close-modal" onclick="closeModal('historyModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="timeline">
                    <div class="timeline-item">
                        <div class="timeline-dot"></div>
                        <div class="timeline-content">
                            <div class="timeline-date">2024-01-15 10:30 صباحاً</div>
                            <div class="timeline-text">
                                <strong>دفع اشتراك:</strong> تم دفع مبلغ 200 ر.س
                            </div>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-dot"></div>
                        <div class="timeline-content">
                            <div class="timeline-date">2024-01-10 02:15 مساءً</div>
                            <div class="timeline-text">
                                <strong>تحديث البيانات:</strong> تم تحديث رقم الجوال
                            </div>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-dot"></div>
                        <div class="timeline-content">
                            <div class="timeline-date">2024-01-05 11:00 صباحاً</div>
                            <div class="timeline-text">
                                <strong>مشاركة في فعالية:</strong> حضور فعالية العائلة السنوية
                            </div>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-dot"></div>
                        <div class="timeline-content">
                            <div class="timeline-date">2023-12-20 09:45 صباحاً</div>
                            <div class="timeline-text">
                                <strong>تسجيل العضوية:</strong> تم تسجيل العضو في النظام
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="exportHistory()">
                    <i class="fas fa-download"></i>
                    تصدير السجل
                </button>
                <button class="btn btn-secondary" onclick="closeModal('historyModal')">
                    <i class="fas fa-times"></i>
                    إغلاق
                </button>
            </div>
        </div>
    </div>

    <!-- Notify Modal -->
    <div class="modal" id="notifyModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>
                    <i class="fas fa-bell"></i>
                    إرسال إشعار
                </h3>
                <button class="close-modal" onclick="closeModal('notifyModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>نوع الإشعار</label>
                    <select class="form-control" id="notificationType">
                        <option>تذكير بالدفع</option>
                        <option>دعوة لفعالية</option>
                        <option>تحديث مهم</option>
                        <option>إعلان عام</option>
                        <option>تهنئة</option>
                        <option>رسالة مخصصة</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>عنوان الإشعار</label>
                    <input type="text" class="form-control" id="notificationTitle" placeholder="مثال: تذكير بسداد الاشتراك الشهري">
                </div>
                <div class="form-group">
                    <label>نص الرسالة</label>
                    <textarea class="form-control" id="notificationMessage" placeholder="اكتب نص الرسالة هنا...

مثال:
عزيزي العضو،
نود تذكيرك بسداد الاشتراك الشهري.
المبلغ المطلوب: 200 ر.س
تاريخ الاستحقاق: 30/10/2025

شكراً لتعاونكم
إدارة عائلة الشعيل"></textarea>
                </div>
                
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                        <i class="fas fa-share-alt" style="color: #667eea;"></i>
                        <strong>قنوات الإرسال</strong>
                    </label>
                    
                    <!-- Mobile App Notification -->
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 2px solid #e9ecef;">
                        <label style="display: flex; align-items: center; gap: 12px; cursor: pointer; margin: 0;">
                            <input type="checkbox" id="sendMobileApp" checked style="width: 20px; height: 20px;">
                            <div style="display: flex; align-items: center; gap: 10px; flex: 1;">
                                <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white;">
                                    <i class="fas fa-mobile-alt" style="font-size: 1.2rem;"></i>
                                </div>
                                <div>
                                    <div style="font-weight: 600; color: #333;">إشعار التطبيق</div>
                                    <div style="font-size: 0.85rem; color: #666;">إشعار فوري داخل تطبيق الجوال</div>
                                </div>
                            </div>
                        </label>
                    </div>

                    <!-- WhatsApp Notification -->
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; border: 2px solid #e9ecef;">
                        <label style="display: flex; align-items: center; gap: 12px; cursor: pointer; margin: 0;">
                            <input type="checkbox" id="sendWhatsApp" style="width: 20px; height: 20px;">
                            <div style="display: flex; align-items: center; gap: 10px; flex: 1;">
                                <div style="width: 40px; height: 40px; background: #25D366; border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white;">
                                    <i class="fab fa-whatsapp" style="font-size: 1.3rem;"></i>
                                </div>
                                <div>
                                    <div style="font-weight: 600; color: #333;">واتساب</div>
                                    <div style="font-size: 0.85rem; color: #666;">إرسال رسالة عبر WhatsApp Business</div>
                                </div>
                            </div>
                        </label>
                        <div id="whatsappPreview" style="margin-top: 15px; padding: 12px; background: white; border-radius: 8px; border-right: 4px solid #25D366; display: none;">
                            <div style="font-size: 0.85rem; color: #666; margin-bottom: 5px;">
                                <i class="fas fa-phone"></i> سيتم الإرسال إلى:
                            </div>
                            <div style="font-weight: 600; color: #25D366;" dir="ltr">+965 9999 8888</div>
                        </div>
                    </div>
                </div>

                <!-- Preview Section -->
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <i class="fas fa-eye" style="color: #667eea;"></i>
                        <strong>معاينة الإشعار</strong>
                    </label>
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 15px; color: white;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <i class="fas fa-bell" style="font-size: 1.2rem;"></i>
                            <strong id="previewTitle">عنوان الإشعار</strong>
                        </div>
                        <div id="previewMessage" style="font-size: 0.95rem; opacity: 0.95; white-space: pre-line;">
                            نص الرسالة سيظهر هنا...
                        </div>
                        <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.3); font-size: 0.85rem; opacity: 0.8;">
                            <i class="far fa-clock"></i> الآن
                        </div>
                    </div>
                </div>

                <!-- Statistics Info -->
                <div style="background: #e3f2fd; padding: 15px; border-radius: 10px; border-right: 4px solid #2196f3;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                        <i class="fas fa-info-circle" style="color: #2196f3;"></i>
                        <strong style="color: #1976d2;">معلومات الإرسال</strong>
                    </div>
                    <div style="font-size: 0.9rem; color: #555;">
                        • عدد المستلمين: <strong id="recipientCount">1</strong> عضو<br>
                        • التكلفة المتوقعة: <strong id="estimatedCost">مجاني</strong><br>
                        • وقت التوصيل: <strong>فوري</strong>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="sendNotification()">
                    <i class="fas fa-paper-plane"></i>
                    إرسال الإشعار
                </button>
                <button class="btn btn-secondary" onclick="closeModal('notifyModal')">
                    <i class="fas fa-times"></i>
                    إلغاء
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <p>جاري التحميل...</p>
        </div>
    </div>

    <!-- Error Toast -->
    <div id="errorToast" class="error-toast" style="display: none;">
        <i class="fas fa-exclamation-circle"></i>
        <span id="errorMessage"></span>
        <button onclick="closeErrorToast()" class="toast-close">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <!-- Success Toast -->
    <div id="successToast" class="success-toast" style="display: none;">
        <i class="fas fa-check-circle"></i>
        <span id="successMessage"></span>
        <button onclick="closeSuccessToast()" class="toast-close">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <script>

        // ===== API Configuration =====
        const API_CONFIG = {
            BASE_URL: 'https://proshael.onrender.com',
            ENDPOINTS: {
                LOGIN: '/api/auth/login',
                MEMBERS: '/api/members',
                STATISTICS: '/api/members/statistics',
                BRANCHES: '/api/tree/branches'
            },
            TIMEOUT: 15000,
            RETRY_ATTEMPTS: 3,
            TOKEN_EXPIRY_DAYS: 7
        };

        // ===== Global State =====
        let allMembers = [];
        let filteredMembers = [];
        let currentPage = 1;
        const pageSize = 25;
        let subscriptionChart = null;
        let branchChart = null;

        // ===== Utility Functions =====
        function showLoadingOverlay() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function hideLoadingOverlay() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        function showError(message) {
            const errorToast = document.getElementById('errorToast');
            const errorMessage = document.getElementById('errorMessage');
            errorMessage.textContent = message;
            errorToast.style.display = 'flex';
            setTimeout(() => closeErrorToast(), 5000);
        }

        function closeErrorToast() {
            document.getElementById('errorToast').style.display = 'none';
        }

        function showSuccess(message) {
            const successToast = document.getElementById('successToast');
            const successMessage = document.getElementById('successMessage');
            successMessage.textContent = message;
            successToast.style.display = 'flex';
            setTimeout(() => closeSuccessToast(), 3000);
        }

        function closeSuccessToast() {
            document.getElementById('successToast').style.display = 'none';
        }

        function showLoginModal() {
            document.getElementById('loginModal').classList.add('active');
            document.getElementById('loginEmail').focus();
        }

        function hideLoginModal() {
            document.getElementById('loginModal').classList.remove('active');
        }

        // ===== API Service Layer =====
        const ApiService = {
            async request(endpoint, options = {}) {
                const token = localStorage.getItem('auth_token');
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), API_CONFIG.TIMEOUT);

                try {
                    const url = `${API_CONFIG.BASE_URL}${endpoint}`;
                    const response = await fetch(url, {
                        ...options,
                        headers: {
                            'Content-Type': 'application/json',
                            ...(token && { 'Authorization': `Bearer ${token}` }),
                            ...options.headers
                        },
                        signal: controller.signal
                    });

                    clearTimeout(timeoutId);

                    if (response.status === 401) {
                        this.handleUnauthorized();
                        throw new Error('غير مصرح - يرجى تسجيل الدخول');
                    }

                    if (response.status === 429) {
                        throw new Error('تم تجاوز عدد الطلبات، يرجى المحاولة بعد قليل');
                    }

                    if (!response.ok) {
                        throw new Error('حدث خطأ في الخادم');
                    }

                    return await response.json();
                } catch (error) {
                    clearTimeout(timeoutId);
                    if (error.name === 'AbortError') {
                        throw new Error('انتهت مهلة الاتصال');
                    }
                    throw error;
                }
            },

            handleUnauthorized() {
                localStorage.removeItem('auth_token');
                localStorage.removeItem('token_expiry');
                localStorage.removeItem('user_email');
                showLoginModal();
            },

            async login(email, password) {
                const data = await this.request(API_CONFIG.ENDPOINTS.LOGIN, {
                    method: 'POST',
                    body: JSON.stringify({ email, password })
                });
                return data;
            },

            async getMembers(page = 1, limit = 500) {
                const data = await this.request(
                    `${API_CONFIG.ENDPOINTS.MEMBERS}?page=${page}&limit=${limit}`
                );
                return data.members || data.data || [];
            },

            async getMemberStats() {
                try {
                    return await this.request(API_CONFIG.ENDPOINTS.STATISTICS);
                } catch (error) {
                    // If stats endpoint doesn't exist, calculate from members
                    return null;
                }
            }
        };

        // ===== Authentication Functions =====
        async function checkAuth() {
            const token = localStorage.getItem('auth_token');
            const tokenExpiry = localStorage.getItem('token_expiry');

            if (!token || !tokenExpiry || Date.now() > parseInt(tokenExpiry)) {
                showLoginModal();
                return false;
            }

            // Verify token is still valid
            try {
                await ApiService.getMembers(1, 1);
                return true;
            } catch (error) {
                showLoginModal();
                return false;
            }
        }

        async function login() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            const rememberMe = document.getElementById('rememberMe').checked;
            const loginButton = document.getElementById('loginButton');
            const loginButtonText = document.getElementById('loginButtonText');
            const loginError = document.getElementById('loginError');

            if (!email || !password) {
                document.getElementById('loginErrorMessage').textContent = 'يرجى إدخال البريد الإلكتروني وكلمة المرور';
                loginError.style.display = 'flex';
                return;
            }

            try {
                loginError.style.display = 'none';
                loginButton.disabled = true;
                loginButtonText.innerHTML = '<div class="spinner"></div> جاري تسجيل الدخول...';

                const data = await ApiService.login(email, password);

                if (data.token) {
                    const expiryDays = rememberMe ? API_CONFIG.TOKEN_EXPIRY_DAYS : 1;
                    const expiryTime = Date.now() + (expiryDays * 24 * 60 * 60 * 1000);

                    localStorage.setItem('auth_token', data.token);
                    localStorage.setItem('token_expiry', expiryTime.toString());
                    localStorage.setItem('user_email', email);

                    hideLoginModal();
                    showSuccess('تم تسجيل الدخول بنجاح');
                    await initDashboard();
                } else {
                    throw new Error('لم يتم استلام رمز التفويض');
                }
            } catch (error) {
                document.getElementById('loginErrorMessage').textContent =
                    error.message || 'بيانات الدخول غير صحيحة';
                loginError.style.display = 'flex';
            } finally {
                loginButton.disabled = false;
                loginButtonText.innerHTML = '<i class="fas fa-sign-in-alt"></i> دخول';
            }
        }

        function logout() {
            if (confirm('هل أنت متأكد من تسجيل الخروج?')) {
                localStorage.removeItem('auth_token');
                localStorage.removeItem('token_expiry');
                localStorage.removeItem('user_email');
                showLoginModal();
                allMembers = [];
                filteredMembers = [];
                showSuccess('تم تسجيل الخروج بنجاح');
            }
        }

        // ===== Dashboard Initialization =====
        async function initDashboard() {
            try {
                showLoadingOverlay();
                const members = await ApiService.getMembers(1, 500);

                allMembers = members;
                filteredMembers = members;

                updateStatistics(members);
                updateChartsWithData(members);
                renderMembersTable(members);

                hideLoadingOverlay();
            } catch (error) {
                hideLoadingOverlay();
                showError(error.message || 'فشل تحميل البيانات');
            }
        }

        // ===== Statistics Calculation =====
        function updateStatistics(members) {
            const stats = {
                total: members.length,
                active: members.filter(m => m.membership_status === 'active').length,
                overdue: members.filter(m =>
                    m.financial_status === 'non-compliant' ||
                    m.financial_status === 'critical'
                ).length,
                suspended: members.filter(m => m.membership_status === 'suspended').length,
                subscriptions: members.reduce((sum, m) => sum + (m.current_balance || 0), 0),
                expired: members.filter(m => m.membership_status === 'pending').length
            };

            // Update stat cards
            document.querySelector('.stat-card:nth-child(1) .stat-number').textContent = stats.total;
            document.querySelector('.stat-card:nth-child(2) .stat-number').textContent = stats.active;
            document.querySelector('.stat-card:nth-child(3) .stat-number').textContent = stats.overdue;
            document.querySelector('.stat-card:nth-child(4) .stat-number').textContent = stats.suspended;
            document.querySelector('.stat-card:nth-child(5) .stat-number').textContent =
                stats.subscriptions.toLocaleString('ar-SA') + ' ر.س';
            document.querySelector('.stat-card:nth-child(6) .stat-number').textContent = stats.expired;
        }
        // Initialize Charts
        window.onload = async function() {
            initSubscriptionChart();
            initBranchChart();

            // Check authentication and load data
            const isAuthenticated = await checkAuth();
            if (isAuthenticated) {
                await initDashboard();
            }
        };
        // Subscription Chart
        function initSubscriptionChart() {
            const ctx = document.getElementById('subscriptionChart').getContext('2d');
            subscriptionChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو'],
                    datasets: [{
                        label: 'الاشتراكات (ر.س)',
                        data: [5000, 7000, 6500, 8000, 9500, 11000],
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Branch Distribution Chart
        function initBranchChart() {
            const ctx = document.getElementById('branchChart').getContext('2d');
            branchChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['رشود', 'رشيد', 'العقاب', 'الشبيعان', 'الدغيش', 'الشامخ'],
                    datasets: [{
                        data: [25, 20, 18, 15, 12, 10],
                        backgroundColor: [
                            '#667eea',
                            '#764ba2',
                            '#f093fb',
                            '#4facfe',
                            '#43e97b',
                            '#fa709a'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // ===== Chart Update Functions =====
        function updateChartsWithData(members) {
            // Update branch distribution pie chart
            updateBranchChart(members);

            // Update subscription line chart (if historical data available)
            updateSubscriptionChartData(members);
        }

        function updateBranchChart(members) {
            if (!branchChart) return;

            // Calculate branch distribution
            const branchCounts = {};
            members.forEach(m => {
                const branch = m.branch_arabic || 'غير محدد';
                branchCounts[branch] = (branchCounts[branch] || 0) + 1;
            });

            // Sort by count descending
            const sortedBranches = Object.entries(branchCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10); // Top 10 branches

            const labels = sortedBranches.map(([branch]) => branch);
            const data = sortedBranches.map(([, count]) => count);

            // Update chart data
            branchChart.data.labels = labels;
            branchChart.data.datasets[0].data = data;
            branchChart.update();
        }

        function updateSubscriptionChartData(members) {
            if (!subscriptionChart) return;

            // Calculate total balance by members (as proxy for subscriptions)
            // If we had historical data, we'd use that instead
            const totalBalance = members.reduce((sum, m) => sum + (m.current_balance || 0), 0);

            // For now, keep the chart with sample data pattern
            // In real implementation, you'd fetch historical data from backend
            // subscriptionChart.data.datasets[0].data = historicalData;
            // subscriptionChart.update();
        }

        // Selection Management
        function updateSelection() {
            const checkboxes = document.querySelectorAll('tbody .member-checkbox:checked');
            const count = checkboxes.length;
            document.getElementById('selectedCount').textContent = count;
            
            const bulkBar = document.getElementById('bulkActionsBar');
            if (count > 0) {
                bulkBar.classList.add('active');
                checkboxes.forEach(cb => {
                    cb.closest('tr').classList.add('selected');
                });
            } else {
                bulkBar.classList.remove('active');
                document.querySelectorAll('tbody tr').forEach(tr => {
                    tr.classList.remove('selected');
                });
            }
        }

        function toggleSelectAll(checkbox) {
            const checkboxes = document.querySelectorAll('tbody .member-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = checkbox.checked;
            });
            updateSelection();
        }

        function selectAll() {
            document.querySelectorAll('tbody .member-checkbox').forEach(cb => {
                cb.checked = true;
            });
            updateSelection();
        }

        function deselectAll() {
            document.querySelectorAll('.member-checkbox').forEach(cb => {
                cb.checked = false;
            });

        // ===== Table Rendering Functions =====
        function renderMembersTable(members) {
            filteredMembers = members;
            currentPage = 1;
            renderCurrentPage();
        }

        function renderCurrentPage() {
            const tbody = document.querySelector('#membersTable tbody');
            if (!tbody) return;

            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = startIndex + pageSize;
            const pageMembers = filteredMembers.slice(startIndex, endIndex);

            tbody.innerHTML = '';

            pageMembers.forEach(member => {
                const row = createMemberRow(member);
                tbody.appendChild(row);
            });

            updatePaginationInfo();
        }

        function createMemberRow(member) {
            const row = document.createElement('tr');

            // Map member data
            const memberId = member.member_number || member.id || 'N/A';
            const name = member.full_name_arabic || member.name || 'غير محدد';
            const phone = member.phone_number || member.phone || 'غير محدد';
            const branch = member.branch_arabic || member.branch || 'غير محدد';
            const membershipStatus = member.membership_status || 'unknown';
            const financialStatus = member.financial_status || 'unknown';
            const balance = member.current_balance || 0;
            const due = member.amount_due || 0;

            // Translate statuses
            const memberStatusText = translateMemberStatus(membershipStatus);
            const memberStatusClass = getMemberStatusClass(membershipStatus);
            const paymentStatusText = translateFinancialStatus(financialStatus);
            const paymentStatusClass = getPaymentStatusClass(financialStatus);

            // Get first letter for avatar
            const firstLetter = name.charAt(0);

            row.innerHTML = `
                <td>
                    <input type="checkbox" class="member-checkbox" data-member-id="${memberId}" onchange="updateSelection()">
                </td>
                <td>
                    <span class="member-number">${memberId}</span>
                </td>
                <td>
                    <div class="member-name">
                        <div class="member-avatar">${firstLetter}</div>
                        <span>${name}</span>
                    </div>
                </td>
                <td>${phone}</td>
                <td>${branch}</td>
                <td>
                    <span class="status-badge ${memberStatusClass}">${memberStatusText}</span>
                </td>
                <td>
                    <span class="status-badge ${paymentStatusClass}">${paymentStatusText}</span>
                </td>
                <td>
                    <span class="amount-display ${balance >= 0 ? 'positive' : 'negative'}">
                        ${balance >= 0 ? '+' : ''}${balance.toLocaleString('ar-SA')} ر.س
                    </span>
                </td>
                <td>
                    <span class="amount-display">${due.toLocaleString('ar-SA')} ر.س</span>
                </td>
                <td>
                    <div class="action-buttons">
                        <button class="btn-action btn-view" onclick="viewMember('${memberId}')" title="عرض التفاصيل">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn-action btn-history" onclick="showHistory('${memberId}')" title="السجل">
                            <i class="fas fa-history"></i>
                        </button>
                        <button class="btn-action btn-notify" onclick="notifyMember('${memberId}')" title="إرسال إشعار">
                            <i class="fas fa-bell"></i>
                        </button>
                        <button class="btn-action btn-whatsapp" onclick="whatsappMember('${memberId}')" title="واتساب">
                            <i class="fab fa-whatsapp"></i>
                        </button>
                        ${membershipStatus === 'suspended' ?
                            `<button class="btn-action btn-success" onclick="activateMember('${memberId}')" title="تفعيل">
                                <i class="fas fa-check"></i>
                            </button>` : ''}
                    </div>
                </td>
            `;

            return row;
        }

        // Status translation functions
        function translateMemberStatus(status) {
            const statusMap = {
                'active': 'نشط',
                'suspended': 'موقوف',
                'pending': 'معلق',
                'inactive': 'غير نشط'
            };
            return statusMap[status] || 'غير محدد';
        }

        function getMemberStatusClass(status) {
            const classMap = {
                'active': 'status-active',
                'suspended': 'status-suspended',
                'pending': 'status-pending',
                'inactive': 'status-inactive'
            };
            return classMap[status] || '';
        }

        function translateFinancialStatus(status) {
            const statusMap = {
                'compliant': 'مدفوع',
                'excellent': 'ممتاز',
                'non-compliant': 'متأخر',
                'critical': 'حرج',
                'partial': 'جزئي'
            };
            return statusMap[status] || 'غير محدد';
        }

        function getPaymentStatusClass(status) {
            const classMap = {
                'compliant': 'payment-paid',
                'excellent': 'payment-paid',
                'non-compliant': 'payment-overdue',
                'critical': 'payment-overdue',
                'partial': 'payment-partial'
            };
            return classMap[status] || '';
        }

        function updatePaginationInfo() {
            const totalMembers = filteredMembers.length;
            const startIndex = (currentPage - 1) * pageSize + 1;
            const endIndex = Math.min(currentPage * pageSize, totalMembers);

            const paginationText = `عرض ${startIndex} - ${endIndex} من ${totalMembers} عضو`;
            const paginationElement = document.querySelector('.pagination-info');
            if (paginationElement) {
                paginationElement.textContent = paginationText;
            }

            // Update pagination buttons
            updatePaginationButtons();
        }

        function updatePaginationButtons() {
            const totalPages = Math.ceil(filteredMembers.length / pageSize);
            const paginationContainer = document.querySelector('.pagination');
            if (!paginationContainer) return;

            // Keep existing pagination buttons but update active state
            const buttons = paginationContainer.querySelectorAll('.page-btn:not(.prev):not(.next)');
            buttons.forEach((btn, index) => {
                if (index + 1 === currentPage) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }

                // Update onclick to use new pagination
                btn.onclick = () => goToPage(index + 1);
            });

            // Update prev/next buttons
            const prevBtn = paginationContainer.querySelector('.prev');
            const nextBtn = paginationContainer.querySelector('.next');
            if (prevBtn) prevBtn.onclick = () => goToPage(currentPage - 1);
            if (nextBtn) nextBtn.onclick = () => goToPage(currentPage + 1);
        }

        function goToPage(page) {
            const totalPages = Math.ceil(filteredMembers.length / pageSize);
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            renderCurrentPage();
        }
            updateSelection();
        }

        // Export to Excel
        function exportToExcel() {
            const table = document.getElementById('membersTable');
            const wb = XLSX.utils.table_to_book(table, {sheet: "الأعضاء"});
            XLSX.writeFile(wb, 'قائمة_الأعضاء_' + new Date().toISOString().split('T')[0] + '.xlsx');
            alert('✅ تم تصدير البيانات إلى Excel بنجاح!');
        }

        // Bulk Actions
        function bulkNotify() {
            const count = document.getElementById('selectedCount').textContent;
            document.getElementById('recipientCount').textContent = count;
            document.getElementById('notifyModal').classList.add('active');
        }

        function bulkWhatsapp() {
            const count = document.getElementById('selectedCount').textContent;
            const checkboxes = document.querySelectorAll('tbody .member-checkbox:checked');
            
            let phoneNumbers = [];
            checkboxes.forEach(cb => {
                const row = cb.closest('tr');
                const phone = row.cells[3].textContent.trim();
                phoneNumbers.push(phone);
            });

            const confirmMsg = `🟢 سيتم إرسال رسالة واتساب إلى ${count} عضو\n\nهل تريد المتابعة؟`;
            
            if (confirm(confirmMsg)) {
                alert(`✅ جاري فتح واتساب...\n\nالأرقام المستهدفة:\n${phoneNumbers.slice(0, 3).join('\n')}${phoneNumbers.length > 3 ? '\n...' : ''}`);
                
                // Open WhatsApp Web for first number (in real app, would use WhatsApp Business API)
                const firstPhone = phoneNumbers[0].replace(/\s+/g, '').replace('+', '');
                window.open(`https://wa.me/${firstPhone}`, '_blank');
            }
        }

        function bulkExport() {
            const count = document.getElementById('selectedCount').textContent;
            alert(`📊 سيتم تصدير بيانات ${count} عضو إلى Excel`);
        }

        // Quick Actions
        function toggleQuickActions() {
            document.getElementById('quickActions').classList.toggle('active');
        }


        // ===== Member Action Functions (Updated for API Data) =====
        function viewMember(memberId) {
            const member = allMembers.find(m => (m.member_number || m.id) === memberId);
            if (member) {
                alert(`عرض تفاصيل العضو: ${member.full_name_arabic || member.name}\nرقم العضو: ${memberId}`);
                // In production, open detail modal or navigate to detail page
            }
        }

        function whatsappMember(memberId) {
            const member = allMembers.find(m => (m.member_number || m.id) === memberId);
            if (member) {
                const phone = (member.phone_number || member.phone || '').replace(/\s/g, '').replace('+', '');
                const name = member.full_name_arabic || member.name || 'العضو';
                const message = encodeURIComponent(`مرحباً ${name}`);
                window.open(`https://wa.me/${phone}?text=${message}`, '_blank');
            }
        }

        function activateMember(memberId) {
            if (confirm('هل أنت متأكد من تفعيل هذا العضو?')) {
                // In production, call API to update member status
                alert('تم تفعيل العضو بنجاح');
                // Refresh data
                initDashboard();
            }
        }

        // ===== Selection Management =====
        function getSelectedMembers() {
            const checkboxes = document.querySelectorAll('.member-checkbox:checked');
            const selectedIds = Array.from(checkboxes).map(cb => cb.dataset.memberId);
            return allMembers.filter(m => selectedIds.includes(m.member_number || m.id));
        }

        // ===== Bulk Actions (Updated) =====
        function bulkNotify() {
            const selected = getSelectedMembers();
            if (selected.length === 0) {
                showError('يرجى اختيار أعضاء أولاً');
                return;
            }

            document.getElementById('recipientCount').textContent = selected.length;
            document.getElementById('notifyModal').classList.add('active');
        }

        function bulkWhatsapp() {
            const selected = getSelectedMembers();
            if (selected.length === 0) {
                showError('يرجى اختيار أعضاء أولاً');
                return;
            }

            // Open WhatsApp for each selected member
            selected.forEach((member, index) => {
                setTimeout(() => {
                    const phone = (member.phone_number || member.phone || '').replace(/\s/g, '').replace('+', '');
                    const name = member.full_name_arabic || member.name || 'العضو';
                    const message = encodeURIComponent(`مرحباً ${name}`);
                    window.open(`https://wa.me/${phone}?text=${message}`, '_blank');
                }, index * 500); // Delay to avoid popup blocking
            });
        }

        function bulkExport() {
            const selected = getSelectedMembers();
            if (selected.length === 0) {
                showError('يرجى اختيار أعضاء أولاً');
                return;
            }
            exportMembersToExcel(selected);
        }

        // ===== Excel Export (Updated for Real Data) =====
        function exportToExcel() {
            exportMembersToExcel(filteredMembers);
        }

        function exportMembersToExcel(members) {
            try {
                const exportData = members.map(member => ({
                    'رقم العضو': member.member_number || member.id || '',
                    'الاسم الكامل': member.full_name_arabic || member.name || '',
                    'رقم الهاتف': member.phone_number || member.phone || '',
                    'الفخذ': member.branch_arabic || member.branch || '',
                    'حالة العضوية': translateMemberStatus(member.membership_status || ''),
                    'الحالة المالية': translateFinancialStatus(member.financial_status || ''),
                    'الرصيد الحالي': member.current_balance || 0,
                    'المبلغ المستحق': member.amount_due || 0,
                    'البريد الإلكتروني': member.email || '',
                    'تاريخ التسجيل': member.registration_date || member.created_at || ''
                }));

                const ws = XLSX.utils.json_to_sheet(exportData);

                // Auto-size columns
                const colWidths = [
                    { wch: 15 }, // رقم العضو
                    { wch: 25 }, // الاسم
                    { wch: 18 }, // الهاتف
                    { wch: 15 }, // الفخذ
                    { wch: 15 }, // حالة العضوية
                    { wch: 15 }, // الحالة المالية
                    { wch: 15 }, // الرصيد
                    { wch: 15 }, // المستحق
                    { wch: 25 }, // البريد
                    { wch: 18 }  // التاريخ
                ];
                ws['!cols'] = colWidths;

                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'الأعضاء');

                // Add statistics sheet
                const statsData = [
                    { 'الإحصائية': 'إجمالي الأعضاء', 'العدد': allMembers.length },
                    { 'الإحصائية': 'الأعضاء النشطون', 'العدد': allMembers.filter(m => m.membership_status === 'active').length },
                    { 'الإحصائية': 'الأعضاء الموقوفون', 'العدد': allMembers.filter(m => m.membership_status === 'suspended').length },
                    { 'الإحصائية': 'المتأخرون في الدفع', 'العدد': allMembers.filter(m => m.financial_status === 'non-compliant' || m.financial_status === 'critical').length }
                ];
                const statsWs = XLSX.utils.json_to_sheet(statsData);
                XLSX.utils.book_append_sheet(wb, statsWs, 'الإحصائيات');

                const fileName = `members-export-${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);

                showSuccess(`تم تصدير ${members.length} عضو بنجاح`);
            } catch (error) {
                showError('فشل تصدير البيانات');
                console.error('Export error:', error);
            }
        }

        // ===== Filter Functions (Updated to work with API data) =====
        function applyFilters() {
            // Get filter values
            const memberNumber = document.getElementById('filterMemberNumber')?.value?.toLowerCase() || '';
            const memberName = document.getElementById('filterMemberName')?.value?.toLowerCase() || '';
            const phone = document.getElementById('filterPhone')?.value || '';
            const branch = document.getElementById('filterBranch')?.value || '';
            const status = document.getElementById('filterStatus')?.value || '';
            const payment = document.getElementById('filterPayment')?.value || '';

            filteredMembers = allMembers.filter(member => {
                const memberId = (member.member_number || member.id || '').toLowerCase();
                const name = (member.full_name_arabic || member.name || '').toLowerCase();
                const memberPhone = member.phone_number || member.phone || '';
                const memberBranch = member.branch_arabic || member.branch || '';
                const memberStatus = member.membership_status || '';
                const paymentStatus = member.financial_status || '';

                return (
                    (!memberNumber || memberId.includes(memberNumber)) &&
                    (!memberName || name.includes(memberName)) &&
                    (!phone || memberPhone.includes(phone)) &&
                    (!branch || memberBranch === branch) &&
                    (!status || memberStatus === status) &&
                    (!payment || paymentStatus === payment)
                );
            });

            currentPage = 1;
            renderCurrentPage();
            updateStatistics(filteredMembers);
            updateChartsWithData(filteredMembers);
        }

        function resetFilters() {
            // Clear all filter inputs
            const filterInputs = document.querySelectorAll('#filterMemberNumber, #filterMemberName, #filterPhone, #filterBranch, #filterStatus, #filterPayment');
            filterInputs.forEach(input => {
                if (input) input.value = '';
            });

            // Reset to all members
            filteredMembers = allMembers;
            currentPage = 1;
            renderCurrentPage();
            updateStatistics(allMembers);
            updateChartsWithData(allMembers);
        }

        // ===== Refresh Data Function =====
        function refreshData() {
            if (confirm('هل تريد تحديث البيانات من الخادم?')) {
                initDashboard();
            }
        }
        function addNewMember() {
            alert('➕ فتح نموذج إضافة عضو جديد...');
        }

        function sendBulkNotifications() {
            // Select all members first
            selectAll();
            // Then open notification modal
            setTimeout(() => {
                const count = document.getElementById('selectedCount').textContent;
                document.getElementById('recipientCount').textContent = count;
                document.getElementById('notifyModal').classList.add('active');
            }, 100);
        }

        function generateReport() {
            alert('📄 جاري إنشاء التقرير...');
        }

        function showOverdue() {
            alert('⚠️ عرض قائمة المتأخرات المالية...');
        }

        function showExpiring() {
            alert('⏰ عرض الاشتراكات المنتهية...');
        }

        // Member Actions
        function viewMember(id) {
            alert(`👁️ عرض تفاصيل العضو #${id}`);
        }

        function showHistory(id) {
            document.getElementById('historyModal').classList.add('active');
        }

        function notifyMember(id) {
            document.getElementById('recipientCount').textContent = '1';
            document.getElementById('notifyModal').classList.add('active');
        }

        function whatsappMember(id) {
            const row = event.target.closest('tr');
            const memberName = row.querySelector('.member-name span').textContent;
            const phone = row.cells[3].textContent.trim().replace(/\s+/g, '').replace('+', '');
            
            const message = encodeURIComponent(`السلام عليكم ${memberName}\nتحية طيبة من إدارة عائلة الشعيل`);
            
            if (confirm(`🟢 فتح واتساب للتواصل مع:\n${memberName}\n${row.cells[3].textContent}`)) {
                window.open(`https://wa.me/${phone}?text=${message}`, '_blank');
            }
        }

        function activateMember(id) {
            if (confirm('هل تريد تنشيط هذا العضو؟')) {
                alert(`✅ تم تنشيط العضو #${id} بنجاح!`);
                location.reload();
            }
        }

        // Modal Functions
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function sendNotification() {
            const mobileApp = document.getElementById('sendMobileApp').checked;
            const whatsapp = document.getElementById('sendWhatsApp').checked;
            const title = document.getElementById('notificationTitle').value;
            const message = document.getElementById('notificationMessage').value;

            if (!mobileApp && !whatsapp) {
                alert('⚠️ يرجى اختيار قناة إرسال واحدة على الأقل!');
                return;
            }

            if (!title || !message) {
                alert('⚠️ يرجى إدخال العنوان والرسالة!');
                return;
            }

            let channels = [];
            if (mobileApp) channels.push('تطبيق الجوال 📱');
            if (whatsapp) channels.push('واتساب 🟢');

            const confirmMsg = `هل تريد إرسال الإشعار عبر:\n${channels.join(' و ')}\n\nالمستلمين: ${document.getElementById('recipientCount').textContent} عضو`;
            
            if (confirm(confirmMsg)) {
                // Simulate sending
                const btn = event.target;
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الإرسال...';
                
                setTimeout(() => {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-paper-plane"></i> إرسال الإشعار';
                    alert('✅ تم إرسال الإشعار بنجاح!\n\n' + channels.join('\n'));
                    closeModal('notifyModal');
                    
                    // Reset form
                    document.getElementById('notificationTitle').value = '';
                    document.getElementById('notificationMessage').value = '';
                    document.getElementById('previewTitle').textContent = 'عنوان الإشعار';
                    document.getElementById('previewMessage').textContent = 'نص الرسالة سيظهر هنا...';
                }, 1500);
            }
        }

        // Live Preview Update
        document.addEventListener('DOMContentLoaded', function() {
            const titleInput = document.getElementById('notificationTitle');
            const messageInput = document.getElementById('notificationMessage');
            const whatsappCheckbox = document.getElementById('sendWhatsApp');
            const whatsappPreview = document.getElementById('whatsappPreview');

            if (titleInput) {
                titleInput.addEventListener('input', function() {
                    const preview = document.getElementById('previewTitle');
                    preview.textContent = this.value || 'عنوان الإشعار';
                });
            }

            if (messageInput) {
                messageInput.addEventListener('input', function() {
                    const preview = document.getElementById('previewMessage');
                    preview.textContent = this.value || 'نص الرسالة سيظهر هنا...';
                });
            }

            if (whatsappCheckbox) {
                whatsappCheckbox.addEventListener('change', function() {
                    if (whatsappPreview) {
                        whatsappPreview.style.display = this.checked ? 'block' : 'none';
                    }
                    updateEstimatedCost();
                });
            }

            document.getElementById('sendMobileApp').addEventListener('change', updateEstimatedCost);
        });

        function updateEstimatedCost() {
            const mobileApp = document.getElementById('sendMobileApp').checked;
            const whatsapp = document.getElementById('sendWhatsApp').checked;
            const costElement = document.getElementById('estimatedCost');

            if (whatsapp && mobileApp) {
                costElement.textContent = 'مجاني للتطبيق + تكلفة واتساب';
            } else if (whatsapp) {
                costElement.textContent = 'حسب تعرفة واتساب';
            } else {
                costElement.textContent = 'مجاني';
            }
        }

        function exportHistory() {
            alert('📥 جاري تصدير السجل...');
        }

        // Filter Tabs
        function switchTab(tab) {
            document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
            event.target.closest('.filter-tab').classList.add('active');
            // Add logic to show different filter panels
        }

        // Table Sorting
        function sortTable(columnIndex) {
            // Add sorting logic here
            alert(`جاري الترتيب حسب العمود ${columnIndex}...`);
        }

        // Other Functions
        function printReport() {
            window.print();
        }

        function refreshData() {
            alert('🔄 جاري تحديث البيانات...');
            location.reload();
        }

        function toggleNotifications() {
            alert('🔔 عرض الإشعارات...');
        }

        // Close modals on outside click
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.remove('active');
                }
            });
        });
    </script>
</body>
</html>
